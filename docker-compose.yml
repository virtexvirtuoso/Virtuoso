version: '3.8'

services:
  # Main Virtuoso application
  virtuoso:
    build: .
    image: virtuoso-ccxt:latest
    container_name: virtuoso-main
    ports:
      - "8001:8001"  # Monitoring API
      - "8002:8002"  # Configuration/Docs API
      - "8003:8003"  # Main Web Server
    environment:
      - MEMCACHED_HOST=memcached
      - REDIS_HOST=redis
      - ENABLE_MULTI_TIER_CACHE=true
      - ENABLE_UNIFIED_ENDPOINTS=true
      # Exchange API Keys (set via .env file or environment)
      - BYBIT_API_KEY=${BYBIT_API_KEY}
      - BYBIT_API_SECRET=${BYBIT_API_SECRET}
      - BINANCE_API_KEY=${BINANCE_API_KEY}
      - BINANCE_SECRET=${BINANCE_SECRET}
      # Discord webhook for alerts
      - DISCORD_WEBHOOK_URL=${DISCORD_WEBHOOK_URL}
    depends_on:
      - memcached
      - redis
    volumes:
      - ./config:/app/config
      - ./logs:/app/logs
      - ./data:/app/data
    restart: unless-stopped
    networks:
      - virtuoso-network

  # Memcached for L2 cache
  memcached:
    image: memcached:alpine
    container_name: virtuoso-memcached
    ports:
      - "11211:11211"
    command: memcached -m 512 -I 10m
    restart: unless-stopped
    networks:
      - virtuoso-network

  # Redis for L3 cache and pub/sub
  redis:
    image: redis:alpine
    container_name: virtuoso-redis
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    command: redis-server --maxmemory 1gb --maxmemory-policy allkeys-lru
    restart: unless-stopped
    networks:
      - virtuoso-network

  # Nginx reverse proxy (optional)
  # NOTE: Commented out - requires nginx.conf to be created first
  # Uncomment and create nginx.conf when ready to use reverse proxy
  # nginx:
  #   image: nginx:alpine
  #   container_name: virtuoso-nginx
  #   ports:
  #     - "80:80"
  #     - "443:443"
  #   volumes:
  #     - ./nginx.conf:/etc/nginx/nginx.conf:ro
  #     - ./ssl:/etc/nginx/ssl:ro
  #   depends_on:
  #     - virtuoso
  #   restart: unless-stopped
  #   networks:
  #     - virtuoso-network

volumes:
  redis-data:
    driver: local

networks:
  virtuoso-network:
    driver: bridge