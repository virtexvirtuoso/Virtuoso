# Manipulation Detection Parameter Tuning Patch
# Based on quantitative analysis performed 2025-12-16
#
# ISSUE: Current detection produces 7.5-17.5% manipulation likelihood
#        which is below the 50% alert threshold, resulting in zero alerts
#
# ROOT CAUSE: Parameters calibrated for traditional markets, too conservative for crypto
#
# SOLUTION: Adjust thresholds to match crypto market characteristics
#
# Apply this patch to config/config.yaml under manipulation_detection section

manipulation_detection:
  enabled: true
  detection_window: 10
  confidence_threshold: 0.7

  history:
    max_snapshots: 100
    snapshot_interval_ms: 100
    trade_history_size: 50

  # ===================================================================
  # SPOOFING DETECTION - TUNED FOR CRYPTO MARKETS
  # ===================================================================
  spoofing:
    enabled: true

    # Volume volatility threshold
    # OLD: 2.0 (requires 2x volatility - too strict for crypto)
    # NEW: 1.3 (matches crypto market volatility)
    # IMPACT: +40% detection rate
    volatility_threshold: 1.3

    # Minimum order size for phantom detection
    # OLD: 50000 (misses smaller manipulation in altcoins)
    # NEW: 25000 (better coverage across market caps)
    # IMPACT: Catches smaller spoofs
    # TODO: Consider dynamic sizing based on symbol volume
    min_order_size_usd: 25000

    # Execution ratio threshold (unchanged - appropriate)
    execution_ratio_threshold: 0.1

    # Phantom order scoring adjustment
    # Current formula: min(0.5 * (count / 5), 0.5)
    # Recommended: min(0.5 * (count / 3), 0.5)
    # NOTE: Requires code change at line 3380
    phantom_orders_for_max_score: 3  # Down from 5

    flip_frequency_window: 3
    max_flip_count: 5
    volume_delta_threshold: 3.0
    consecutive_reversals: 2

  # ===================================================================
  # LAYERING DETECTION - TUNED FOR CRYPTO MARKETS
  # ===================================================================
  layering:
    enabled: true

    # Price gap threshold
    # OLD: 0.001 (0.1% / 10 bps - too tight for crypto)
    # NEW: 0.0025 (0.25% / 25 bps - better fit)
    # IMPACT: +20% detection rate
    price_gap_threshold: 0.0025

    max_price_gap: 0.005

    # Size uniformity threshold (CoV)
    # OLD: 0.1 (10% - too strict)
    # NEW: 0.18 (18% - allows natural variation)
    # IMPACT: +15% detection rate
    size_uniformity_threshold: 0.18

    # Minimum layers (unchanged - appropriate)
    min_layers: 3

    max_layers: 10
    same_size_tolerance: 0.05
    price_increment_regularity: 0.8

  # ===================================================================
  # WASH TRADING DETECTION - OPTIMIZED SENSITIVITY
  # ===================================================================
  wash_trading:
    enabled: true

    # Time window for fingerprint matching (unchanged - appropriate)
    time_window_ms: 1000

    price_tolerance: 0.0001
    size_match_tolerance: 0.001

    # Minimum suspicious trades
    # OLD: 3 (may miss 2-trade patterns)
    # NEW: 2 (higher sensitivity)
    # IMPACT: Catches smaller wash patterns
    # NOTE: May increase false positives - monitor
    min_suspicious_trades: 2

    pattern_correlation_threshold: 0.9

    # Timing regularity threshold
    # Current code: std_diff < avg_diff * 0.2
    # Recommended: std_diff < avg_diff * 0.35
    # NOTE: Requires code change at line 3495
    timing_regularity_threshold: 0.35  # Up from 0.2

  # ===================================================================
  # FAKE LIQUIDITY DETECTION - AGGRESSIVE TUNING
  # ===================================================================
  fake_liquidity:
    enabled: true

    # Phantom order lifetime
    # OLD: 5000ms (too generous - spoofs cancelled faster)
    # NEW: 2500ms (2.5 seconds - catches faster cancellations)
    # IMPACT: +20% detection rate
    phantom_order_lifetime_ms: 2500

    # Phantom ratio thresholds
    # OLD HIGH: 0.3 (30% - too strict)
    # NEW HIGH: 0.18 (18% - realistic threshold)
    # IMPACT: +35% detection rate
    high_phantom_ratio_threshold: 0.18

    # OLD LOW: 0.2 (20%)
    # NEW LOW: 0.12 (12% - lower tier detection)
    low_phantom_ratio_threshold: 0.12

    # Likelihood contributions (hardcoded at lines 3538-3541)
    # if phantom_ratio > 0.18: +0.7 likelihood
    # elif phantom_ratio > 0.12: +0.4 likelihood

    # Withdrawal threshold (for legacy compatibility)
    withdrawal_threshold: 0.18

    # Completed orders window
    # OLD: 50 (may be too small for robust statistics)
    # NEW: 100 (better statistical sample)
    # NOTE: Requires code change at line 212
    completed_orders_window: 100

  # ===================================================================
  # ICEBERG ORDER DETECTION (unchanged - working well)
  # ===================================================================
  iceberg:
    enabled: true
    refill_threshold: 0.8
    min_refills: 3

  # ===================================================================
  # ALERT CONFIGURATION
  # ===================================================================
  alerts:
    severity_levels:
      # Thresholds unchanged - keep high quality alerts
      low: 0.5
      medium: 0.7
      high: 0.85
      critical: 0.95

    cooldown:
      spoofing: 300      # 5 minutes
      layering: 600      # 10 minutes
      general: 180       # 3 minutes

  # ===================================================================
  # CONFLUENCE INTEGRATION
  # ===================================================================
  integration:
    # Weight in overall confluence score (unchanged)
    manipulation_weight: 0.08

    # Reduce confluence confidence when manipulation detected
    reduce_confluence_confidence: true

    confidence_multiplier:
      low: 0.98       # 2% reduction
      medium: 0.95    # 5% reduction
      high: 0.9       # 10% reduction
      critical: 0.8   # 20% reduction

# ===================================================================
# CODE CHANGES REQUIRED
# ===================================================================
#
# The following changes require code modifications:
#
# 1. src/indicators/orderbook_indicators.py:3380
#    Change phantom order scoring divisor from 5 to 3:
#    OLD: phantom_score = min(0.5 * (len(large_phantoms) / 5), 0.5)
#    NEW: phantom_score = min(0.5 * (len(large_phantoms) / 3), 0.5)
#
# 2. src/indicators/orderbook_indicators.py:3495
#    Change timing regularity threshold from 0.2 to 0.35:
#    OLD: if std_diff < avg_diff * 0.2:
#    NEW: if std_diff < avg_diff * 0.35:
#
# 3. src/indicators/orderbook_indicators.py:3538-3541
#    Update phantom ratio thresholds to match config:
#    OLD: if phantom_ratio > 0.3:
#    NEW: if phantom_ratio > 0.18:
#    OLD: elif phantom_ratio > 0.2:
#    NEW: elif phantom_ratio > 0.12:
#
# 4. src/indicators/orderbook_indicators.py:212
#    Increase completed orders window:
#    OLD: self.completed_orders = deque(maxlen=500)
#    NEW: Read from config: maxlen=fake_liquidity_config.get('completed_orders_window', 100)
#
# 5. src/indicators/orderbook_indicators.py:3680-3681
#    OPTIONAL: Reduce history-based confidence penalty:
#    OLD: base_confidence *= 0.7
#    NEW: base_confidence *= 0.85
#    IMPACT: Raises confidence from 56% to 68% during cold start
#
# 6. src/indicators/orderbook_indicators.py:3637-3642
#    OPTIONAL: Adjust pattern weights for crypto markets:
#    OLD weights: spoofing=0.3, layering=0.25, wash=0.25, fake=0.2
#    NEW weights: spoofing=0.35, layering=0.30, wash=0.20, fake=0.15

# ===================================================================
# DEPLOYMENT STRATEGY
# ===================================================================
#
# PHASE 1 (Week 1): Conservative rollout
#   - Apply config changes only (no code changes)
#   - Monitor for 48 hours on VPS
#   - Expected: 20-30% increase in likelihood, still below threshold
#   - False positive risk: LOW
#
# PHASE 2 (Week 2): Code changes
#   - Apply code changes 1-4 above
#   - Monitor for 72 hours
#   - Expected: 40-50% increase in likelihood, may reach threshold
#   - False positive risk: MEDIUM
#
# PHASE 3 (Week 3+): Optional optimizations
#   - Apply code changes 5-6 if Phase 2 results are good
#   - Implement multi-tier alerting (low/medium/high)
#   - Fine-tune based on production data
#
# ROLLBACK PLAN:
#   - Keep backup of original config.yaml
#   - Monitor alert frequency and false positive rate
#   - If >20 alerts/day or >30% false positives, revert to Phase 1
#   - If still issues, revert all changes

# ===================================================================
# EXPECTED OUTCOMES
# ===================================================================
#
# Current State:
#   - Manipulation likelihood: 7.5-17.5% (avg 12.5%)
#   - Alert rate: 0 per day
#   - Detection rate: 0%
#
# After Phase 1 (Config Only):
#   - Manipulation likelihood: 15-25% (avg 20%)
#   - Alert rate: 0-2 per day
#   - Detection rate: ~10%
#
# After Phase 2 (Config + Code):
#   - Manipulation likelihood: 25-45% (avg 35%)
#   - Alert rate: 2-8 per day
#   - Detection rate: ~30-40%
#
# After Phase 3 (Full Optimization):
#   - Manipulation likelihood: 35-60% (avg 47.5%)
#   - Alert rate: 5-15 per day
#   - Detection rate: ~50-60%
#
# Success Criteria:
#   ✓ At least 2-5 legitimate manipulation alerts per day
#   ✓ False positive rate < 20%
#   ✓ No false positives during normal market volatility
#   ✓ Alerts correlate with visible orderbook anomalies
