<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Virtuoso Mobile Dashboard</title>
    <meta name="description" content="Mobile-optimized cryptocurrency trading dashboard">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Virtuoso">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="application-name" content="Virtuoso">
    <meta name="theme-color" content="#0a1525">
    
    <!-- PWA Manifest for Android -->
    <link rel="manifest" href="/static/manifest.json">
    
    <!-- Custom Favicon with Amber Trending-Up Icon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8IS0tIERhcmsgYmFja2dyb3VuZCBtYXRjaGluZyBkYXNoYm9hcmQgdGhlbWUgLS0+CiAgPHJlY3Qgd2lkdGg9IjI0IiBoZWlnaHQ9IjI0IiByeD0iNCIgZmlsbD0iIzBhMTUyNSIvPgogIAogIDwhLS0gQW1iZXIgdHJlbmRpbmctdXAgaWNvbiAtLT4KICA8cGF0aCBkPSJtMyAxNyA2LTYgNCA0IDgtOCIgc3Ryb2tlPSIjRkZCRjAwIiBzdHJva2Utd2lkdGg9IjIiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCIvPgogIDxwYXRoIGQ9Im0yMSA3LTQgNFY3aDR6IiBmaWxsPSIjRkZCRjAwIiBzdHJva2U9IiNGRkJGMDAiIHN0cm9rZS13aWR0aD0iMiIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIi8+Cjwvc3ZnPg==">
    
    <!-- Apple Touch Icons for iOS Home Screen -->
    <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTgwIiBoZWlnaHQ9IjE4MCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPgogIDxyZWN0IHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgcng9IjQiIGZpbGw9IiMwYTE1MjUiLz4KICA8cGF0aCBkPSJtMyAxNyA2LTYgNCA0IDgtOCIgc3Ryb2tlPSIjRkZCRjAwIiBzdHJva2Utd2lkdGg9IjIiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCIvPgogIDxwYXRoIGQ9Im0yMSA3LTQgNFY3aDR6IiBmaWxsPSIjRkZCRjAwIiBzdHJva2U9IiNGRkJGMDAiIHN0cm9rZS13aWR0aD0iMiIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIi8+Cjwvc3ZnPg==">
    <link rel="apple-touch-icon" sizes="152x152" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTUyIiBoZWlnaHQ9IjE1MiIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPgogIDxyZWN0IHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgcng9IjQiIGZpbGw9IiMwYTE1MjUiLz4KICA8cGF0aCBkPSJtMyAxNyA2LTYgNCA0IDgtOCIgc3Ryb2tlPSIjRkZCRjAwIiBzdHJva2Utd2lkdGg9IjIiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCIvPgogIDxwYXRoIGQ9Im0yMSA3LTQgNFY3aDR6IiBmaWxsPSIjRkZCRjAwIiBzdHJva2U9IiNGRkJGMDAiIHN0cm9rZS13aWR0aD0iMiIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIi8+Cjwvc3ZnPg==">
    <link rel="apple-touch-icon" sizes="180x180" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTgwIiBoZWlnaHQ9IjE4MCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPgogIDxyZWN0IHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgcng9IjQiIGZpbGw9IiMwYTE1MjUiLz4KICA8cGF0aCBkPSJtMyAxNyA2LTYgNCA0IDgtOCIgc3Ryb2tlPSIjRkZCRjAwIiBzdHJva2Utd2lkdGg9IjIiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCIvPgogIDxwYXRoIGQ9Im0yMSA3LTQgNFY3aDR6IiBmaWxsPSIjRkZCRjAwIiBzdHJva2U9IiNGRkJGMDAiIHN0cm9rZS13aWR0aD0iMiIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIi8+Cjwvc3ZnPg==">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <style>
        /* Mobile-First Terminal Amber + Navy Blue Theme */
        :root {
            --bg-primary: #0c1a2b;
            --bg-secondary: #0f172a;
            --bg-panel: #1a2332;
            --text-primary: #ffbf00;
            --text-secondary: #b8860b;
            --accent-primary: #ff9900;
            --accent-positive: #4caf50;
            --accent-negative: #f44336;
            --accent-warning: #ff9900;
            --border-light: #1a2a40;
            --mobile-header-height: 70px;
            --mobile-nav-height: 65px;
            --safe-area-top: env(safe-area-inset-top);
            --safe-area-bottom: env(safe-area-inset-bottom);
            --content-padding: 20px;
            --card-gap: 20px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        /* Hardware acceleration for smooth scrolling */
        html {
            -webkit-overflow-scrolling: touch;
        }
        
        /* Optimize font rendering */
        html, body {
            text-rendering: optimizeSpeed;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.5;
            min-height: 100vh;
            overflow-x: hidden;
            padding-top: var(--safe-area-top);
            padding-bottom: var(--safe-area-bottom);
            -webkit-font-smoothing: antialiased;
        }

        /* Mobile Header */
        .mobile-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: calc(var(--mobile-header-height) + var(--safe-area-top));
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-light);
            display: flex;
            align-items: center;
            padding: 0 16px;
            padding-top: var(--safe-area-top);
            z-index: 1000;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }

        .app-title {
            font-size: 22px;
            font-weight: 700;
            color: var(--accent-primary);
            letter-spacing: 1px;
        }

        .header-actions {
            display: flex;
            gap: 16px;
        }

        .header-btn {
            background: transparent;
            border: none;
            color: var(--text-primary);
            padding: 12px;
            cursor: pointer;
            border-radius: 12px;
            transition: background 0.2s;
            min-width: 44px;
            min-height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .header-btn:active {
            background: rgba(255, 191, 0, 0.1);
        }

        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: calc(var(--mobile-nav-height) + var(--safe-area-bottom));
            background: var(--bg-secondary);
            border-top: 1px solid var(--border-light);
            display: flex;
            padding-bottom: var(--safe-area-bottom);
            z-index: 1000;
            box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.3);
        }

        .nav-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 8px;
            cursor: pointer;
            transition: background 0.2s;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            text-decoration: none;
        }

        .nav-item.active {
            color: var(--accent-primary);
            background: rgba(255, 153, 0, 0.1);
        }

        .nav-item:active {
            background: rgba(255, 191, 0, 0.15);
        }

        .nav-icon {
            width: 28px;
            height: 28px;
            margin-bottom: 6px;
        }

        .nav-label {
            font-size: 12px;
            font-weight: 600;
            letter-spacing: 0.3px;
        }

        /* Main Content Area */
        .main-content {
            padding-top: calc(var(--mobile-header-height) + var(--safe-area-top));
            padding-bottom: calc(var(--mobile-nav-height) + var(--safe-area-bottom));
            min-height: 100vh;
        }
        
        /* Dynamic Island Safe Area */
        @supports (padding: max(0px)) {
            .mobile-header {
                padding-top: max(var(--safe-area-top), 20px);
            }
            .main-content {
                padding-top: calc(var(--mobile-header-height) + max(var(--safe-area-top), 20px));
            }
        }

        /* Tab Content */
        .tab-content {
            display: none;
            padding: var(--content-padding);
            animation: fadeIn 0.3s ease;
            max-width: 430px;
            margin: 0 auto;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Mobile Cards */
        .mobile-card {
            background: var(--bg-panel);
            border: 1px solid var(--border-light);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: var(--card-gap);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            /* Hardware acceleration & performance */
            transform: translate3d(0, 0, 0);
            contain: layout style paint;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .card-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-primary);
            letter-spacing: 0.3px;
        }

        .card-badge {
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 12px;
            font-weight: 500;
        }

        /* Signal Cards */
        .signal-card {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid var(--border-light);
        }

        .signal-card:last-child {
            border-bottom: none;
        }

        .signal-info {
            flex: 1;
        }

        .signal-symbol {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 6px;
        }

        .signal-details {
            font-size: 14px;
            color: var(--text-secondary);
            line-height: 1.4;
        }

        .signal-score {
            font-size: 22px;
            font-weight: 700;
            padding: 10px 16px;
            border-radius: 12px;
            text-align: center;
            min-width: 75px;
        }

        .score-high {
            background: rgba(76, 175, 80, 0.2);
            color: var(--accent-positive);
        }

        .score-medium {
            background: rgba(255, 153, 0, 0.2);
            color: var(--accent-warning);
        }

        .score-low {
            background: rgba(244, 67, 54, 0.2);
            color: var(--accent-negative);
        }

        /* Symbols Grid */
        .symbols-grid {
            display: flex;
            flex-direction: column;
            gap: 12px;
            max-height: 400px;
            overflow-y: auto;
        }

        .symbol-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: var(--bg-secondary);
            border-radius: 8px;
            border: 1px solid var(--border-light);
            cursor: pointer;
            transition: all 0.2s;
        }

        .symbol-item:active {
            transform: scale(0.98);
            background: rgba(255, 191, 0, 0.1);
        }

        .symbol-info {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
        }

        .symbol-name {
            font-weight: 600;
            font-size: 16px;
            color: var(--text-primary);
        }

        .symbol-price {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .symbol-metrics {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .confluence-score {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 50px;
        }

        .score-value {
            font-size: 18px;
            font-weight: 700;
        }

        .score-label {
            font-size: 10px;
            color: var(--text-secondary);
            text-transform: uppercase;
        }

        .symbol-change {
            font-size: 14px;
            font-weight: 600;
            padding: 4px 8px;
            border-radius: 4px;
        }

        .change-positive {
            color: var(--accent-positive);
            background: rgba(76, 175, 80, 0.1);
        }

        .change-negative {
            color: var(--accent-negative);
            background: rgba(244, 67, 54, 0.1);
        }

        .change-neutral {
            color: var(--text-secondary);
            background: rgba(255, 191, 0, 0.1);
        }

        /* Matrix View (Simplified for Mobile) */
        .matrix-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 20px;
        }

        /* Symbols Grid */
        .symbols-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            margin-top: 16px;
        }

        .symbol-item {
            background: var(--bg-panel);
            border: 1px solid var(--border-light);
            border-radius: 12px;
            padding: 16px 8px;
            text-align: center;
            cursor: pointer;
            transition: transform 0.15s ease-out;
            min-height: 70px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            /* Hardware acceleration */
            transform: translate3d(0, 0, 0);
            backface-visibility: hidden;
            will-change: transform;
            contain: layout style;
        }

        .symbol-item:active {
            transform: translate3d(0, 0, 0) scale(0.98);
            background: rgba(255, 191, 0, 0.1);
        }

        .symbol-name {
            font-size: 13px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 6px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            letter-spacing: 0.3px;
        }

        .symbol-change {
            font-size: 15px;
            font-weight: 800;
        }

        .change-positive {
            color: var(--accent-positive);
        }

        .change-negative {
            color: var(--accent-negative);
        }

        .change-neutral {
            color: var(--text-secondary);
        }

        .matrix-item {
            background: var(--bg-panel);
            border: 1px solid var(--border-light);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            min-height: 90px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .matrix-item:active {
            transform: scale(0.98);
            background: rgba(255, 191, 0, 0.1);
        }

        .matrix-symbol {
            font-size: 16px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 10px;
            letter-spacing: 0.3px;
        }

        .matrix-value {
            font-size: 20px;
            font-weight: 700;
        }

        /* Opportunity List */
        .opportunity-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .opportunity-item {
            background: var(--bg-panel);
            border: 1px solid var(--border-light);
            border-radius: 12px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .opportunity-item:active {
            transform: scale(0.98);
            background: rgba(255, 191, 0, 0.05);
        }

        .opportunity-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .opportunity-metrics {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        .metric-item {
            text-align: center;
            padding: 8px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 6px;
        }

        .metric-value {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .metric-label {
            font-size: 8px;
            color: var(--text-secondary);
            text-transform: uppercase;
            margin-top: 2px;
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        .action-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: var(--accent-primary);
            color: var(--bg-primary);
        }

        .btn-secondary {
            background: rgba(255, 191, 0, 0.2);
            color: var(--text-primary);
            border: 1px solid var(--border-light);
        }

        .action-btn:active {
            transform: scale(0.98);
        }

        /* Pull to Refresh */
        .pull-to-refresh {
            position: absolute;
            top: calc(var(--mobile-header-height) + var(--safe-area-top));
            left: 0;
            right: 0;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
            font-size: 14px;
            transform: translateY(-60px);
            transition: transform 0.3s;
        }

        .pull-to-refresh.active {
            transform: translateY(0);
        }

        /* Loading States */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 40px;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border-light);
            border-top-color: var(--accent-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Empty States */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-secondary);
        }

        .empty-icon {
            width: 64px;
            height: 64px;
            margin: 0 auto 16px;
            opacity: 0.5;
        }

        .empty-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-primary);
        }

        .empty-text {
            font-size: 14px;
            line-height: 1.5;
        }

        /* Responsive Typography */
        @media (max-width: 375px) {
            .app-title { font-size: 16px; }
            .card-title { font-size: 14px; }
            .signal-symbol { font-size: 13px; }
            .signal-score { font-size: 16px; }
            .symbols-grid { grid-template-columns: repeat(2, 1fr); }
            .symbol-name { font-size: 10px; }
            .symbol-change { font-size: 12px; }
        }

        /* Dark Mode Support */
        @media (prefers-color-scheme: dark) {
            :root {
                --bg-primary: #0c1a2b;
                --bg-secondary: #0f172a;
            }
        }

        /* Landscape Adjustments */
        @media (orientation: landscape) and (max-height: 600px) {
            .mobile-header { height: 50px; }
            .bottom-nav { height: 45px; }
            .nav-icon { width: 20px; height: 20px; }
            .nav-label { font-size: 10px; }
        }
    </style>
</head>
<body>
    <!-- Mobile Header -->
    <header class="mobile-header">
        <div class="header-content">
            <h1 class="app-title" style="display: flex; align-items: center;">
                <i data-lucide="trending-up" style="width: 24px; height: 24px; margin-right: 8px; color: var(--accent-warning);"></i>
                VIRTUOSO
            </h1>
            <div class="header-actions">
                <button class="header-btn" onclick="refreshData()">
                    <i data-lucide="refresh-cw" class="header-icon"></i>
                </button>
                <button class="header-btn" onclick="toggleSettings()">
                    <i data-lucide="settings" class="header-icon"></i>
                </button>
            </div>
        </div>
    </header>

    <!-- Pull to Refresh -->
    <div class="pull-to-refresh" id="pullToRefresh">
        <i data-lucide="refresh-cw" style="width: 16px; height: 16px; margin-right: 8px;"></i>
        <span>Pull to refresh</span>
    </div>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Dashboard Tab -->
        <div class="tab-content active" id="dashboardTab">
            <!-- Market Overview -->
            <div class="mobile-card">
                <div class="card-header">
                    <h2 class="card-title">Market Overview</h2>
                    <span class="card-badge" style="background: rgba(76, 175, 80, 0.2); color: var(--accent-positive);">
                        LIVE
                    </span>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
                    <!-- Market Regime -->
                    <div class="overview-metric">
                        <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 4px;">MARKET REGIME</div>
                        <div id="marketRegime" style="font-size: 16px; font-weight: 700; padding: 4px 8px; border-radius: 6px; text-align: center; background: rgba(255, 191, 0, 0.1); color: var(--text-primary);">
                            LOADING...
                        </div>
                    </div>
                    
                    <!-- Trend Strength -->
                    <div class="overview-metric">
                        <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 4px;">TREND STRENGTH</div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <div id="trendStrength" style="font-size: 18px; font-weight: 700;">0</div>
                            <div style="flex: 1; height: 8px; background: rgba(255, 255, 255, 0.1); border-radius: 4px; overflow: hidden;">
                                <div id="trendStrengthBar" style="height: 100%; width: 0%; background: var(--accent-primary); transition: width 0.3s ease;"></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Market Volatility -->
                    <div class="overview-metric">
                        <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 4px;">VOLATILITY</div>
                        <div style="font-size: 14px;">
                            <span id="currentVolatility" style="font-weight: 700; color: var(--text-primary);">0%</span>
                            <span style="color: var(--text-secondary); font-size: 12px;"> vs </span>
                            <span id="avgVolatility" style="color: var(--text-secondary);">0%</span>
                        </div>
                        <div style="font-size: 10px; margin-top: 2px;">
                            <span id="volatilityDescriptor" style="font-weight: 600; text-transform: uppercase;">-</span>
                        </div>
                    </div>
                    
                    <!-- BTC Dominance -->
                    <div class="overview-metric">
                        <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 4px;">BTC DOMINANCE</div>
                        <div id="btcDominance" style="font-size: 16px; font-weight: 700; color: var(--accent-warning);">
                            0%
                        </div>
                    </div>
                </div>
                
                <!-- Improved Market Breadth -->
                <div class="breadth-visual" style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border-light);">
                    <div class="breadth-title" style="font-size: 11px; color: var(--text-secondary); margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px;">Market Sentiment <span class="live-indicator" style="display: inline-block; width: 6px; height: 6px; background: var(--accent-positive); border-radius: 50%; margin-left: 6px; animation: pulse 2s infinite;"></span></div>
                    <div class="breadth-main" style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                        <div class="market-icon" id="marketIcon" style="width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: all 0.3s ease; background: rgba(76, 175, 80, 0.2); color: var(--accent-positive);">
                            <i data-lucide="trending-up" style="width: 24px; height: 24px;"></i>
                        </div>
                        <div class="breadth-details" style="flex: 1;">
                            <div class="breadth-label" id="marketLabel" style="font-size: 14px; font-weight: 600; margin-bottom: 4px;">Loading...</div>
                            <div class="breadth-bar-container" style="height: 24px; background: #0a1018; border-radius: 12px; overflow: hidden; position: relative; margin-bottom: 6px;">
                                <div class="breadth-bar-fill" style="height: 100%; display: flex; align-items: center; transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);">
                                    <div class="bull-section" id="bullSection" style="background: var(--accent-positive); height: 100%; display: flex; align-items: center; justify-content: center; color: white; font-size: 11px; font-weight: 700; transition: width 0.5s ease; width: 50%;">50%</div>
                                    <div class="bear-section" id="bearSection" style="background: var(--accent-negative); height: 100%; display: flex; align-items: center; justify-content: center; color: white; font-size: 11px; font-weight: 700; transition: width 0.5s ease; width: 50%;">50%</div>
                                </div>
                            </div>
                            <div class="breadth-stats" style="display: flex; justify-content: space-between; font-size: 12px; color: var(--text-muted);">
                                <span class="stat-item" style="display: flex; align-items: center; gap: 4px;">
                                    <i data-lucide="arrow-up" style="width: 12px; height: 12px; color: var(--accent-positive);"></i>
                                    <span class="stat-value" id="upCount" style="font-weight: 600; color: var(--text-primary);">0</span>
                                    <span>rising</span>
                                </span>
                                <span class="stat-item" style="display: flex; align-items: center; gap: 4px;">
                                    <i data-lucide="arrow-down" style="width: 12px; height: 12px; color: var(--accent-negative);"></i>
                                    <span class="stat-value" id="downCount" style="font-weight: 600; color: var(--text-primary);">0</span>
                                    <span>falling</span>
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Total Volume -->
                <div class="overview-metric" style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border-light);">
                    <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 4px;">24H TOTAL VOLUME</div>
                    <div id="totalVolume" style="font-size: 20px; font-weight: 700; color: var(--text-primary);">
                        $0
                    </div>
                </div>
            </div>

            <!-- Confluence Scores -->
            <div class="mobile-card">
                <div class="card-header">
                    <h2 class="card-title">Confluence Scores</h2>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <span class="card-badge" id="symbolsCount" style="background: rgba(255, 191, 0, 0.2); color: var(--text-primary);">
                            0
                        </span>
                        <select id="sortSelector" style="background: var(--bg-secondary); border: 1px solid var(--border-light); border-radius: 6px; padding: 6px 12px; color: var(--text-primary); font-size: 12px;" onchange="sortSymbols()">
                            <option value="score">Sort by Score</option>
                            <option value="change">Sort by Change</option>
                            <option value="volume">Sort by Volume</option>
                            <option value="symbol">Sort by Symbol</option>
                        </select>
                    </div>
                </div>
                
                <div class="symbols-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(170px, 1fr)); gap: 16px; padding: 4px;">
                    <div id="analyzedSymbolsList">
                        <!-- Confluence score cards will be populated here -->
                        <div class="loading" style="text-align: center; padding: 40px; grid-column: 1 / -1;">
                            <div class="spinner" style="width: 32px; height: 32px; margin: 0 auto;"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Winners & Losers Section -->
            <div class="mobile-card">
                <div class="card-header">
                    <h2 class="card-title">Top Movers - All Markets</h2>
                    <span class="card-badge" style="background: rgba(255, 191, 0, 0.2); color: var(--text-primary);">
                        24H
                    </span>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <!-- Winners Column -->
                    <div>
                        <h4 style="font-size: 13px; font-weight: 600; color: var(--accent-positive); margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.5px;">
                            ðŸ”¥ TOP GAINERS
                        </h4>
                        <div id="topGainersList" style="display: flex; flex-direction: column; gap: 8px;">
                            <!-- Winners will be populated here -->
                            <div class="loading" style="text-align: center; padding: 20px;">
                                <div class="spinner" style="width: 24px; height: 24px; margin: 0 auto;"></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Losers Column -->
                    <div>
                        <h4 style="font-size: 13px; font-weight: 600; color: var(--accent-negative); margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.5px;">
                            ðŸ“‰ TOP LOSERS
                        </h4>
                        <div id="topLosersList" style="display: flex; flex-direction: column; gap: 8px;">
                            <!-- Losers will be populated here -->
                            <div class="loading" style="text-align: center; padding: 20px;">
                                <div class="spinner" style="width: 24px; height: 24px; margin: 0 auto;"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>


            <!-- Top Opportunities -->
            <div class="mobile-card">
                <div class="card-header">
                    <h2 class="card-title">Top Opportunities</h2>
                    <span class="card-badge" style="background: rgba(255, 153, 0, 0.2); color: var(--accent-warning);">
                        HOT
                    </span>
                </div>
                <div class="opportunity-list" id="opportunitiesList">
                    <!-- Opportunities will be populated here -->
                </div>
            </div>
        </div>

        <!-- Signals Tab -->
        <div class="tab-content" id="signalsTab">
            <div class="mobile-card">
                <div class="card-header">
                    <h2 class="card-title">Live Signals</h2>
                    <span class="card-badge" id="signalCount" style="background: rgba(255, 191, 0, 0.2); color: var(--text-primary);">
                        0
                    </span>
                </div>
                <div id="signalsList">
                    <!-- Signals will be populated here -->
                </div>
            </div>
        </div>

        <!-- Alpha Tab -->
        <div class="tab-content" id="alphaTab">
            <div class="mobile-card">
                <div class="card-header">
                    <h2 class="card-title">Alpha Opportunities</h2>
                    <span class="card-badge" style="background: rgba(76, 175, 80, 0.2); color: var(--accent-positive);">
                        ALPHA
                    </span>
                </div>
                <div id="alphaList">
                    <!-- Alpha opportunities will be populated here -->
                </div>
            </div>
        </div>

        <!-- Alerts Tab -->
        <div class="tab-content" id="alertsTab">
            <div class="mobile-card">
                <div class="card-header">
                    <h2 class="card-title">Recent Alerts</h2>
                    <span class="card-badge" id="alertCount" style="background: rgba(244, 67, 54, 0.2); color: var(--accent-negative);">
                        0
                    </span>
                </div>
                <div id="alertsList">
                    <!-- Alerts will be populated here -->
                </div>
            </div>
        </div>

        <!-- Bitcoin Beta Tab -->
        <div class="tab-content" id="betaTab">
            <div class="mobile-card">
                <div class="card-header">
                    <h2 class="card-title">Bitcoin Beta Analysis</h2>
                    <span class="card-badge" style="background: rgba(255, 191, 0, 0.2); color: var(--accent-warning);">
                        â‚¿
                    </span>
                </div>
                
                <!-- Beta Overview -->
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 16px;">
                    <div class="overview-metric">
                        <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 4px;">BETA COEFFICIENT</div>
                        <div id="betaCoefficient" style="font-size: 20px; font-weight: 700; color: var(--text-primary);">--</div>
                    </div>
                    <div class="overview-metric">
                        <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 4px;">CORRELATION</div>
                        <div id="btcCorrelation" style="font-size: 20px; font-weight: 700; color: var(--text-primary);">--</div>
                    </div>
                    <div class="overview-metric">
                        <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 4px;">MARKET REGIME</div>
                        <div id="betaMarketRegime" style="font-size: 14px; font-weight: 600; padding: 4px 8px; border-radius: 6px; text-align: center; background: rgba(255, 191, 0, 0.1); color: var(--text-primary);">--</div>
                    </div>
                    <div class="overview-metric">
                        <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 4px;">VOLATILITY RATIO</div>
                        <div id="volatilityRatio" style="font-size: 20px; font-weight: 700; color: var(--text-primary);">--</div>
                    </div>
                </div>
            </div>

            <!-- Beta Performance Chart -->
            <div class="mobile-card">
                <div class="card-header">
                    <h2 class="card-title">Beta Performance</h2>
                    <select id="betaChartPeriod" style="background: var(--bg-secondary); border: 1px solid var(--border-light); border-radius: 6px; padding: 6px 12px; color: var(--text-primary); font-size: 12px;" onchange="updateBetaChart()">
                        <option value="24h">24 Hours</option>
                        <option value="7d" selected>7 Days</option>
                        <option value="30d">30 Days</option>
                    </select>
                </div>
                <div style="position: relative; width: 100%; height: 200px; padding: 12px;">
                    <canvas id="betaChart" style="width: 100%; height: 100%;"></canvas>
                </div>
                <div style="display: flex; flex-wrap: wrap; gap: 8px; padding: 12px; padding-top: 0;">
                    <div id="betaChartLegend" style="display: flex; flex-wrap: wrap; gap: 12px; font-size: 11px;">
                        <!-- Legend items will be added here -->
                    </div>
                </div>
            </div>

            <!-- Symbol Beta Rankings -->
            <div class="mobile-card">
                <div class="card-header">
                    <h2 class="card-title">Beta Rankings</h2>
                    <select id="betaSortSelector" style="background: var(--bg-secondary); border: 1px solid var(--border-light); border-radius: 6px; padding: 6px 12px; color: var(--text-primary); font-size: 12px;" onchange="sortBetaSymbols()">
                        <option value="beta">Sort by Beta</option>
                        <option value="correlation">Sort by Correlation</option>
                        <option value="volume">Sort by Volume</option>
                    </select>
                </div>
                <div id="betaSymbolsList" style="display: flex; flex-direction: column; gap: 8px;">
                    <!-- Beta rankings will be populated here -->
                    <div class="loading" style="text-align: center; padding: 40px;">
                        <div class="spinner" style="width: 32px; height: 32px; margin: 0 auto;"></div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Bottom Navigation -->
    <nav class="bottom-nav">
        <button class="nav-item active" onclick="switchTab('dashboard')">
            <i data-lucide="home" class="nav-icon"></i>
            <span class="nav-label">Dashboard</span>
        </button>
        <button class="nav-item" onclick="switchTab('signals')">
            <i data-lucide="activity" class="nav-icon"></i>
            <span class="nav-label">Signals</span>
        </button>
        <button class="nav-item" onclick="switchTab('beta')">
            <span class="nav-icon" style="font-size: 20px; font-weight: 700;">â‚¿</span>
            <span class="nav-label">â‚¿ Beta</span>
        </button>
        <button class="nav-item" onclick="switchTab('alpha')">
            <i data-lucide="trending-up" class="nav-icon"></i>
            <span class="nav-label">Alpha</span>
        </button>
        <button class="nav-item" onclick="switchTab('alerts')">
            <i data-lucide="bell" class="nav-icon"></i>
            <span class="nav-label">Alerts</span>
        </button>
    </nav>

    <!-- Settings Panel -->
    <div id="settingsPanel" class="settings-panel" style="position: fixed; top: 0; right: -100%; width: 320px; height: 100vh; background: var(--bg-primary); border-left: 1px solid var(--border-light); z-index: 1000; transition: right 0.3s ease; overflow-y: auto;">
        <div class="settings-header" style="padding: 20px; border-bottom: 1px solid var(--border-light); display: flex; justify-content: space-between; align-items: center;">
            <h3 style="color: var(--text-primary); font-size: 18px; font-weight: 700; margin: 0;">Settings</h3>
            <button onclick="toggleSettings()" style="background: none; border: none; cursor: pointer;">
                <i data-lucide="x" style="width: 20px; height: 20px; color: var(--text-secondary);"></i>
            </button>
        </div>
        
        <div class="settings-content" style="padding: 20px;">
            <!-- Display Preferences -->
            <div class="settings-section" style="margin-bottom: 24px;">
                <h4 style="color: var(--text-primary); font-size: 14px; font-weight: 600; margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.5px;">Display</h4>
                
                <div class="setting-item" style="margin-bottom: 12px;">
                    <label style="display: flex; justify-content: space-between; align-items: center; color: var(--text-secondary); font-size: 13px;">
                        Auto Refresh
                        <select id="refreshRate" style="background: var(--bg-secondary); border: 1px solid var(--border-light); border-radius: 4px; padding: 4px 8px; color: var(--text-primary); font-size: 12px;" onchange="updateRefreshRate()">
                            <option value="0">Manual</option>
                            <option value="30000">30 seconds</option>
                            <option value="60000" selected>1 minute</option>
                            <option value="120000">2 minutes</option>
                            <option value="300000">5 minutes</option>
                        </select>
                    </label>
                </div>
                
                <div class="setting-item" style="margin-bottom: 12px;">
                    <label style="display: flex; justify-content: space-between; align-items: center; color: var(--text-secondary); font-size: 13px;">
                        Default Sort
                        <select id="defaultSort" style="background: var(--bg-secondary); border: 1px solid var(--border-light); border-radius: 4px; padding: 4px 8px; color: var(--text-primary); font-size: 12px;" onchange="updateDefaultSort()">
                            <option value="score" selected>Confluence Score</option>
                            <option value="change">Price Change</option>
                            <option value="symbol">Symbol Name</option>
                        </select>
                    </label>
                </div>
                
                <div class="setting-item" style="margin-bottom: 12px;">
                    <label style="display: flex; justify-content: space-between; align-items: center; color: var(--text-secondary); font-size: 13px;">
                        Symbols Limit
                        <select id="symbolsLimit" style="background: var(--bg-secondary); border: 1px solid var(--border-light); border-radius: 4px; padding: 4px 8px; color: var(--text-primary); font-size: 12px;" onchange="updateSymbolsLimit()">
                            <option value="10">10 symbols</option>
                            <option value="20" selected>20 symbols</option>
                            <option value="50">50 symbols</option>
                            <option value="100">All symbols</option>
                        </select>
                    </label>
                </div>
            </div>
            
            <!-- Alert Settings -->
            <div class="settings-section" style="margin-bottom: 24px;">
                <h4 style="color: var(--text-primary); font-size: 14px; font-weight: 600; margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.5px;">Alerts</h4>
                
                <div class="setting-item" style="margin-bottom: 12px;">
                    <label style="display: flex; justify-content: space-between; align-items: center; color: var(--text-secondary); font-size: 13px;">
                        Min Confluence Score
                        <select id="minConfluence" style="background: var(--bg-secondary); border: 1px solid var(--border-light); border-radius: 4px; padding: 4px 8px; color: var(--text-primary); font-size: 12px;" onchange="updateMinConfluence()">
                            <option value="50">50+</option>
                            <option value="60">60+</option>
                            <option value="70" selected>70+</option>
                            <option value="80">80+</option>
                        </select>
                    </label>
                </div>
                
                <div class="setting-item" style="margin-bottom: 12px;">
                    <label style="display: flex; justify-content: space-between; align-items: center; color: var(--text-secondary); font-size: 13px;">
                        Sound Alerts
                        <input type="checkbox" id="soundAlerts" style="accent-color: var(--accent-primary);" onchange="updateSoundAlerts()">
                    </label>
                </div>
            </div>
            
            <!-- Dashboard Cards -->
            <div class="settings-section" style="margin-bottom: 24px;">
                <h4 style="color: var(--text-primary); font-size: 14px; font-weight: 600; margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.5px;">Visible Cards</h4>
                
                <div class="setting-item" style="margin-bottom: 8px;">
                    <label style="display: flex; justify-content: space-between; align-items: center; color: var(--text-secondary); font-size: 13px;">
                        Market Overview
                        <input type="checkbox" id="showMarketOverview" checked style="accent-color: var(--accent-primary);" onchange="toggleCard('marketOverview')">
                    </label>
                </div>
                
                <div class="setting-item" style="margin-bottom: 8px;">
                    <label style="display: flex; justify-content: space-between; align-items: center; color: var(--text-secondary); font-size: 13px;">
                        Top Movers
                        <input type="checkbox" id="showTopMovers" checked style="accent-color: var(--accent-primary);" onchange="toggleCard('topMovers')">
                    </label>
                </div>
                
                <div class="setting-item" style="margin-bottom: 8px;">
                    <label style="display: flex; justify-content: space-between; align-items: center; color: var(--text-secondary); font-size: 13px;">
                        Top Opportunities
                        <input type="checkbox" id="showOpportunities" checked style="accent-color: var(--accent-primary);" onchange="toggleCard('opportunities')">
                    </label>
                </div>
            </div>
            
            <!-- Actions -->
            <div class="settings-section">
                <button onclick="resetSettings()" style="width: 100%; background: var(--bg-secondary); border: 1px solid var(--border-light); border-radius: 8px; padding: 12px; color: var(--text-primary); font-size: 13px; cursor: pointer; margin-bottom: 12px;">
                    Reset to Defaults
                </button>
                <button onclick="exportSettings()" style="width: 100%; background: var(--accent-primary); border: none; border-radius: 8px; padding: 12px; color: white; font-size: 13px; cursor: pointer;">
                    Export Settings
                </button>
            </div>
        </div>
    </div>
    
    <!-- Settings Overlay -->
    <div id="settingsOverlay" class="settings-overlay" style="position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0, 0, 0, 0.5); z-index: 999; opacity: 0; visibility: hidden; transition: all 0.3s ease;" onclick="toggleSettings()"></div>

    <script>
        // Initialize Lucide icons
        lucide.createIcons();

        // Tab switching
        function switchTab(tabName) {
            // Update nav items
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });

            // Find and activate the clicked nav item
            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(item => {
                const onclick = item.getAttribute('onclick');
                if (onclick && onclick.includes(`'${tabName}'`)) {
                    item.classList.add('active');
                }
            });

            // Update content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(tabName + 'Tab').classList.add('active');

            // Load tab-specific data
            loadTabData(tabName);
        }

        // Load tab data
        function loadTabData(tabName) {
            switch(tabName) {
                case 'dashboard':
                    loadDashboardData();
                    break;
                case 'signals':
                    loadSignalsData();
                    break;
                case 'alpha':
                    loadAlphaData();
                    break;
                case 'alerts':
                    loadAlertsData();
                    break;
                case 'beta':
                    loadBetaData();
                    break;
            }
        }

        // Performance-optimized pull to refresh
        let startY = 0;
        let isPulling = false;
        let rafId = null;
        const pullToRefresh = document.getElementById('pullToRefresh');
        const mainContent = document.querySelector('.main-content');

        // Use passive event listeners for better performance
        mainContent.addEventListener('touchstart', (e) => {
            if (window.scrollY === 0) {
                startY = e.touches[0].pageY;
                isPulling = true;
            }
        }, { passive: true });

        mainContent.addEventListener('touchmove', (e) => {
            if (!isPulling) return;
            
            // Cancel previous animation frame
            if (rafId) {
                cancelAnimationFrame(rafId);
            }
            
            rafId = requestAnimationFrame(() => {
                const currentY = e.touches[0].pageY;
                const pullDistance = currentY - startY;
                
                if (pullDistance > 0 && pullDistance < 100) {
                    pullToRefresh.classList.add('active');
                    // Use transform for better performance
                    pullToRefresh.style.transform = `translate3d(0, ${Math.min(pullDistance - 60, 0)}px, 0)`;
                }
            });
        }, { passive: true });

        mainContent.addEventListener('touchend', () => {
            if (rafId) {
                cancelAnimationFrame(rafId);
                rafId = null;
            }
            if (isPulling && pullToRefresh.classList.contains('active')) {
                refreshData();
            }
            isPulling = false;
            pullToRefresh.classList.remove('active');
            pullToRefresh.style.transform = '';
        }, { passive: true });

        // Data validation helper functions
        function safeExtractValue(data, fallback = '', debug = false) {
            if (debug) console.log('Extracting value from:', data);
            
            if (data === null || data === undefined) return fallback;
            
            // If it's already a primitive value
            if (typeof data === 'string' || typeof data === 'number' || typeof data === 'boolean') {
                return String(data).replace(/[{}",]/g, '').trim();
            }
            
            // If it's an object, try to extract meaningful value
            if (typeof data === 'object') {
                // Try common property names for regime/status
                if (data.regime) return String(data.regime).replace(/[{}",]/g, '').trim();
                if (data.status) return String(data.status).replace(/[{}",]/g, '').trim();
                if (data.value) return String(data.value).replace(/[{}",]/g, '').trim();
                
                // Get first non-null value from object
                const values = Object.values(data).filter(v => v !== null && v !== undefined);
                if (values.length > 0) {
                    return String(values[0]).replace(/[{}",]/g, '').trim();
                }
            }
            
            return fallback;
        }

        // Market breadth update function
        function updateMarketBreadth(upCount, downCount) {
            const total = upCount + downCount;
            
            // Handle case when no data available
            if (total === 0) {
                document.getElementById('marketLabel').textContent = 'No Data';
                document.getElementById('upCount').textContent = '0';
                document.getElementById('downCount').textContent = '0';
                document.getElementById('bullSection').style.width = '50%';
                document.getElementById('bullSection').textContent = '50%';
                document.getElementById('bearSection').style.width = '50%';
                document.getElementById('bearSection').textContent = '50%';
                return;
            }
            
            const bullPercent = Math.round((upCount / total) * 100);
            const bearPercent = 100 - bullPercent;
            
            // Update visual elements
            document.getElementById('bullSection').style.width = bullPercent + '%';
            document.getElementById('bullSection').textContent = bullPercent + '%';
            document.getElementById('bearSection').style.width = bearPercent + '%';
            document.getElementById('bearSection').textContent = bearPercent + '%';
            document.getElementById('upCount').textContent = upCount;
            document.getElementById('downCount').textContent = downCount;
            
            // Update icon and label based on sentiment
            const iconContainer = document.getElementById('marketIcon');
            const label = document.getElementById('marketLabel');
            
            if (bullPercent > 60) {
                iconContainer.className = 'market-icon bullish';
                iconContainer.innerHTML = '<i data-lucide="trending-up" style="width: 24px; height: 24px;"></i>';
                iconContainer.style.background = 'rgba(76, 175, 80, 0.2)';
                iconContainer.style.color = 'var(--accent-positive)';
                label.textContent = 'Bulls Leading';
            } else if (bullPercent < 40) {
                iconContainer.className = 'market-icon bearish';
                iconContainer.innerHTML = '<i data-lucide="trending-down" style="width: 24px; height: 24px;"></i>';
                iconContainer.style.background = 'rgba(244, 67, 54, 0.2)';
                iconContainer.style.color = 'var(--accent-negative)';
                label.textContent = 'Bears Leading';
            } else {
                iconContainer.className = 'market-icon neutral';
                iconContainer.innerHTML = '<i data-lucide="minus" style="width: 24px; height: 24px;"></i>';
                iconContainer.style.background = 'rgba(255, 191, 0, 0.1)';
                iconContainer.style.color = 'var(--text-primary)';
                label.textContent = 'Market Balanced';
            }
            
            // Re-initialize Lucide icons for the new elements
            lucide.createIcons();
        }

        // Data loading functions
        async function loadDashboardData() {
            try {
                // Load summary, symbols, market overview, and movers data
                const [summaryResponse, symbolsResponse, marketResponse, mobileDataResponse] = await Promise.all([
                    fetch('/api/dashboard/overview'),
                    fetch('/api/dashboard/symbols'),
                    fetch('/api/dashboard/market-overview'),
                    fetch('/api/dashboard/mobile-data')
                ]);
                
                const summaryData = await summaryResponse.json();
                const symbolsData = await symbolsResponse.json();
                const marketData = await marketResponse.json();
                const mobileData = await mobileDataResponse.json();
                
                updateDashboard(summaryData);
                updateSymbols(symbolsData);
                updateMarketOverview(marketData);
                
                // Use our new mobile-data endpoint for top movers
                if (mobileData.status === 'success') {
                    updateTopMovers(mobileData.top_movers);
                    // Update confluence scores if needed - filter out system status entries
                    if (mobileData.confluence_scores) {
                        console.log('Raw confluence scores:', mobileData.confluence_scores);
                        const validScores = mobileData.confluence_scores.filter(score => 
                            score && 
                            score.symbol && 
                            score.symbol !== 'SYSTEM_STATUS' && 
                            score.sentiment !== 'INITIALIZING' &&
                            !score.symbol.includes('SYSTEM')
                        );
                        console.log('Filtered valid scores:', validScores);
                        if (validScores.length > 0) {
                            updateSymbols({ symbols: validScores });
                        } else {
                            // If no valid scores, show empty state
                            console.log('No valid confluence scores, showing empty state');
                            updateSymbols({ symbols: [] });
                        }
                    }
                }
            } catch (error) {
                console.error('Error loading dashboard data:', error);
            }
        }

        async function loadSignalsData() {
            try {
                // Fetch from dashboard signals endpoint which provides real signal data
                const response = await fetch('/api/dashboard/signals');
                const data = await response.json();
                updateSignals(data);
            } catch (error) {
                console.error('Error loading signals data:', error);
                // Fallback to empty state
                updateSignals([]);
            }
        }


        async function loadAlphaData() {
            try {
                const response = await fetch('/api/dashboard/opportunities');
                const data = await response.json();
                updateAlpha(data);
            } catch (error) {
                console.error('Error loading alpha data:', error);
            }
        }

        async function loadAlertsData() {
            try {
                const response = await fetch('/api/dashboard/alerts');
                const data = await response.json();
                updateAlerts(data);
            } catch (error) {
                console.error('Error loading alerts data:', error);
            }
        }
        
        async function loadBetaData() {
            try {
                // Use the real-time bitcoin beta endpoint
                const response = await fetch('/api/bitcoin-beta/realtime');
                const data = await response.json();
                
                if (data.status === 'success' && data.overview && data.symbols) {
                    // Update overview with real data
                    updateBetaOverview({
                        beta_coefficient: data.overview.market_beta || 1.0,
                        correlation: data.overview.avg_correlation || 0.5,
                        market_regime: data.overview.market_regime || 'NEUTRAL',
                        volatility_ratio: data.overview.market_beta || 1.0
                    });
                    
                    // Transform symbols data for display
                    const betaSymbols = data.symbols.map(sym => ({
                        symbol: sym.symbol.replace('USDT', ''),
                        price: sym.last_price || 0,
                        change_24h: sym.change_24h || 0,
                        beta: sym.beta_30d || 1.0,
                        correlation: sym.correlation_30d || 0.5,
                        volume_24h: sym.volume_24h || 0,
                        risk_category: sym.risk_category?.category || 'Market Neutral',
                        risk_color: sym.risk_category?.color || '#6B7280',
                        alpha: sym.alpha_30d || 0,
                        r_squared: sym.r_squared_30d || 0
                    }));
                    
                    // Update beta symbols table
                    updateBetaSymbols({ symbols: betaSymbols });
                    
                    // Store data for charts
                    window.betaData = data;
                    
                    // Initialize and update chart
                    if (document.getElementById('betaChart')) {
                        initBetaChart();
                    }
                } else if (data.status === 'error') {
                    // Try fallback endpoint if available
                    const fallbackResponse = await fetch('/api/dashboard/mobile/beta-dashboard');
                    const fallbackData = await fallbackResponse.json();
                    
                    if (fallbackData.status === 'success') {
                        updateBetaOverview({
                            beta_coefficient: fallbackData.overview.market_beta,
                            correlation: 0.85,
                            market_regime: fallbackData.overview.market_beta > 1.2 ? 'high_volatility' : 'normal',
                            volatility_ratio: fallbackData.overview.avg_portfolio_beta
                        });
                        updateBetaSymbols({ symbols: fallbackData.beta_table });
                    }
                } else {
                    throw new Error('Invalid data format');
                }
            } catch (error) {
                console.error('Error loading beta data:', error);
                // Show error state
                updateBetaOverview({
                    beta_coefficient: 0,
                    correlation: 0,
                    market_regime: 'unknown',
                    volatility_ratio: 0
                });
            }
        }
        
        function updateBetaOverview(data) {
            console.log('Beta overview data:', data);  // Debug log
            
            // Update beta coefficient
            const betaCoef = document.getElementById('betaCoefficient');
            if (betaCoef) {
                const beta = data.beta_coefficient || 0;
                betaCoef.textContent = beta.toFixed(2);
                betaCoef.style.color = beta > 1 ? 'var(--accent-negative)' : beta < 1 ? 'var(--accent-positive)' : 'var(--text-primary)';
            }
            
            // Update correlation
            const correlation = document.getElementById('btcCorrelation');
            if (correlation) {
                const corr = data.correlation || 0;
                correlation.textContent = (corr * 100).toFixed(0) + '%';
                correlation.style.color = corr > 0.7 ? 'var(--accent-positive)' : corr < 0.3 ? 'var(--accent-negative)' : 'var(--accent-warning)';
            }
            
            // Update market regime - use safe extraction
            const regime = document.getElementById('betaMarketRegime');
            if (regime) {
                const regimeData = data.market_regime || 'NEUTRAL';
                const marketRegime = safeExtractValue(regimeData, 'NEUTRAL').toUpperCase();
                
                // Format display text
                const displayText = marketRegime.replace(/_/g, ' ');
                regime.textContent = displayText;
                
                const regimeColors = {
                    'RISK_ON': 'rgba(76, 175, 80, 0.2)',
                    'RISK_OFF': 'rgba(244, 67, 54, 0.2)',
                    'NEUTRAL': 'rgba(255, 191, 0, 0.2)',
                    'CORRELATED_CRASH': 'rgba(239, 68, 68, 0.3)'
                };
                regime.style.background = regimeColors[marketRegime] || regimeColors.NEUTRAL;
            }
            
            // Update volatility ratio
            const volRatio = document.getElementById('volatilityRatio');
            if (volRatio) {
                const ratio = data.volatility_ratio || 0;
                volRatio.textContent = ratio.toFixed(2) + 'x';
            }
        }
        
        let currentBetaSymbols = [];
        
        function updateBetaSymbols(data) {
            const symbolsList = document.getElementById('betaSymbolsList');
            if (!symbolsList) return;
            
            // Use real beta data from our endpoint
            const symbols = data.symbols || data;
            currentBetaSymbols = symbols.map(symbol => {
                // Data already includes real beta coefficients
                return {
                    symbol: symbol.symbol,
                    price: symbol.price || 0,
                    change_24h: symbol.change_24h || 0,
                    beta: symbol.beta || 1.0,
                    correlation: symbol.correlation || 0.5,
                    volume_usd: symbol.volume_24h || 0,
                    risk_category: symbol.risk_category || 'Medium Risk',
                    risk_color: symbol.risk_color || 'yellow'
                };
            });
            
            // Sort by beta by default
            sortBetaSymbols();
        }
        
        function sortBetaSymbols() {
            const sortBy = document.getElementById('betaSortSelector')?.value || 'beta';
            let sorted = [...currentBetaSymbols];
            
            switch(sortBy) {
                case 'beta':
                    sorted.sort((a, b) => b.beta - a.beta);
                    break;
                case 'correlation':
                    sorted.sort((a, b) => b.correlation - a.correlation);
                    break;
                case 'volume':
                    sorted.sort((a, b) => b.volume_usd - a.volume_usd);
                    break;
            }
            
            renderBetaSymbols(sorted);
        }
        
        function renderBetaSymbols(symbols) {
            const symbolsList = document.getElementById('betaSymbolsList');
            if (!symbolsList) return;
            
            symbolsList.innerHTML = '';
            
            if (symbols.length === 0) {
                symbolsList.innerHTML = '<div class="empty-state" style="text-align: center; padding: 20px; color: var(--text-secondary);">No beta data available</div>';
                return;
            }
            
            symbols.slice(0, 10).forEach(symbol => {
                const riskColor = symbol.risk_color === 'red' ? 'var(--accent-negative)' :
                                 symbol.risk_color === 'yellow' ? 'var(--accent-warning)' :
                                 'var(--accent-positive)';

                // Calculate beta color and class based on beta value
                const beta = symbol.beta || 1.0;
                let betaColor, betaClass;

                if (beta > 1.5) {
                    betaColor = 'var(--accent-negative)';  // High beta = high risk = red
                    betaClass = 'high-beta';
                } else if (beta > 1.1) {
                    betaColor = 'var(--accent-warning)';   // Moderate beta = amber
                    betaClass = 'moderate-beta';
                } else if (beta >= 0.9) {
                    betaColor = 'var(--text-primary)';     // Market beta = neutral
                    betaClass = 'market-beta';
                } else if (beta >= 0.5) {
                    betaColor = 'var(--accent-positive)';  // Low beta = defensive = green
                    betaClass = 'low-beta';
                } else {
                    betaColor = '#6B7280';                 // Very low beta = gray
                    betaClass = 'defensive';
                }

                symbolsList.innerHTML += `
                    <div class="signal-card" style="cursor: pointer;" onclick="viewSymbolBeta('${symbol.symbol}')">
                        <div class="signal-info">
                            <div class="signal-symbol">${symbol.symbol}</div>
                            <div class="signal-details">
                                Beta: ${symbol.beta.toFixed(2)} â€¢ Correlation: ${(symbol.correlation * 100).toFixed(0)}%
                            </div>
                            <div style="font-size: 11px; color: ${riskColor}; margin-top: 4px;">
                                ${symbol.risk_category}
                            </div>
                            <div class="signal-details" style="font-size: 12px; margin-top: 4px;">
                                $${(symbol.price || 0).toFixed(2)} â€¢ Vol: ${((symbol.volume_usd || 0) / 1000000).toFixed(2)}M
                            </div>
                        </div>
                        <div style="display: flex; flex-direction: column; align-items: flex-end; gap: 4px;">
                            <div style="font-size: 24px; font-weight: 700; color: ${betaColor};">
                                ${symbol.beta.toFixed(2)}
                            </div>
                            <div class="card-badge" style="background: ${betaColor}20; color: ${betaColor}; font-size: 10px;">
                                ${betaClass.toUpperCase().replace('-', ' ')}
                            </div>
                        </div>
                    </div>
                `;
            });
        }
        
        function viewSymbolBeta(symbol) {
            // Could expand to show detailed beta analysis for the symbol
            console.log('View beta details for:', symbol);
        }
        
        // Beta Chart Functions
        let betaChartData = null;
        let betaChartCanvas = null;
        let betaChartCtx = null;
        
        function initBetaChart() {
            betaChartCanvas = document.getElementById('betaChart');
            if (betaChartCanvas) {
                betaChartCtx = betaChartCanvas.getContext('2d');
                updateBetaChart();
            }
        }
        
        async function fetchBetaHistory(symbol, period = '7d') {
            try {
                // Try to fetch real historical data first
                const cleanSymbol = symbol.includes('USDT') ? symbol : symbol + 'USDT';
                const response = await fetch(`/api/bitcoin-beta/history/${cleanSymbol}`);
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.history && data.history.length > 0) {
                        return data.history;
                    }
                }
                
                // Fallback to generating mock data if no real data available
                const points = period === '24h' ? 24 : period === '7d' ? 168 : 720;
                const interval = period === '24h' ? 1 : period === '7d' ? 1 : 1;
                
                const history = [];
                const now = Date.now();
                
                // Use actual beta from currentBetaSymbols if available
                const symbolData = currentBetaSymbols.find(s => s.symbol === symbol);
                let baseBeta = symbolData ? symbolData.beta : (1.0 + Math.random() * 0.5);
                
                for (let i = points; i >= 0; i--) {
                    const timestamp = now - (i * interval * 3600000);
                    const variation = (Math.random() - 0.5) * 0.05; // Smaller variations
                    baseBeta = Math.max(0.5, Math.min(2.5, baseBeta + variation));
                    history.push({
                        timestamp: timestamp,
                        beta: baseBeta,
                        correlation: symbolData ? symbolData.correlation : (0.5 + Math.random() * 0.4)
                    });
                }
                
                return history;
            } catch (error) {
                console.error('Error fetching beta history:', error);
                return [];
            }
        }
        
        async function updateBetaChart() {
            if (!betaChartCanvas || !betaChartCtx) {
                initBetaChart();
                return;
            }
            
            const period = document.getElementById('betaChartPeriod')?.value || '7d';
            
            // Get top 5 symbols by beta
            const topSymbols = currentBetaSymbols
                .sort((a, b) => b.beta - a.beta)
                .slice(0, 5);
            
            // Fetch history for each symbol
            const chartData = {};
            const colors = ['#FF6B35', '#4ECDC4', '#FFE66D', '#8B5CF6', '#06B6D4'];
            
            for (let i = 0; i < topSymbols.length; i++) {
                const symbol = topSymbols[i];
                const history = await fetchBetaHistory(symbol.symbol, period);
                chartData[symbol.symbol] = {
                    data: history,
                    color: colors[i],
                    beta: symbol.beta
                };
            }
            
            // Also add Bitcoin as reference
            const btcHistory = await fetchBetaHistory('BTC', period);
            chartData['BTC'] = {
                data: btcHistory.map(h => ({ ...h, beta: 1.0 })), // BTC always has beta of 1
                color: '#FF9500',
                beta: 1.0
            };
            
            renderBetaChart(chartData, period);
        }
        
        function renderBetaChart(data, period) {
            if (!betaChartCtx) return;
            
            const rect = betaChartCanvas.getBoundingClientRect();
            const dpr = window.devicePixelRatio || 1;
            
            // Set canvas size
            betaChartCanvas.width = rect.width * dpr;
            betaChartCanvas.height = rect.height * dpr;
            betaChartCtx.scale(dpr, dpr);
            
            const width = rect.width;
            const height = rect.height;
            
            // Clear canvas
            betaChartCtx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--bg-secondary');
            betaChartCtx.fillRect(0, 0, width, height);
            
            const margin = { top: 20, right: 20, bottom: 30, left: 40 };
            const chartWidth = width - margin.left - margin.right;
            const chartHeight = height - margin.top - margin.bottom;
            
            // Find data bounds
            let minBeta = Infinity;
            let maxBeta = -Infinity;
            let minTime = Infinity;
            let maxTime = -Infinity;
            
            Object.values(data).forEach(series => {
                series.data.forEach(point => {
                    minBeta = Math.min(minBeta, point.beta);
                    maxBeta = Math.max(maxBeta, point.beta);
                    minTime = Math.min(minTime, point.timestamp);
                    maxTime = Math.max(maxTime, point.timestamp);
                });
            });
            
            // Add padding to beta range
            const betaRange = maxBeta - minBeta;
            minBeta -= betaRange * 0.1;
            maxBeta += betaRange * 0.1;
            
            // Draw grid lines
            betaChartCtx.strokeStyle = 'rgba(255, 255, 255, 0.05)';
            betaChartCtx.lineWidth = 1;
            
            // Horizontal grid lines
            for (let i = 0; i <= 5; i++) {
                const y = margin.top + (chartHeight * i / 5);
                betaChartCtx.beginPath();
                betaChartCtx.moveTo(margin.left, y);
                betaChartCtx.lineTo(margin.left + chartWidth, y);
                betaChartCtx.stroke();
                
                // Beta labels
                const betaValue = maxBeta - (maxBeta - minBeta) * i / 5;
                betaChartCtx.fillStyle = 'rgba(255, 255, 255, 0.5)';
                betaChartCtx.font = '10px Inter, system-ui, sans-serif';
                betaChartCtx.textAlign = 'right';
                betaChartCtx.fillText(betaValue.toFixed(2), margin.left - 5, y + 3);
            }
            
            // Draw beta = 1.0 reference line (market beta)
            const marketBetaY = margin.top + chartHeight * (maxBeta - 1.0) / (maxBeta - minBeta);
            betaChartCtx.strokeStyle = 'rgba(255, 149, 0, 0.3)';
            betaChartCtx.setLineDash([5, 5]);
            betaChartCtx.beginPath();
            betaChartCtx.moveTo(margin.left, marketBetaY);
            betaChartCtx.lineTo(margin.left + chartWidth, marketBetaY);
            betaChartCtx.stroke();
            betaChartCtx.setLineDash([]);
            
            // Draw lines for each symbol
            Object.entries(data).forEach(([symbol, series]) => {
                if (series.data.length === 0) return;
                
                betaChartCtx.strokeStyle = series.color;
                betaChartCtx.lineWidth = symbol === 'BTC' ? 2 : 1.5;
                betaChartCtx.globalAlpha = symbol === 'BTC' ? 0.6 : 0.8;
                
                betaChartCtx.beginPath();
                series.data.forEach((point, i) => {
                    const x = margin.left + chartWidth * (point.timestamp - minTime) / (maxTime - minTime);
                    const y = margin.top + chartHeight * (maxBeta - point.beta) / (maxBeta - minBeta);
                    
                    if (i === 0) {
                        betaChartCtx.moveTo(x, y);
                    } else {
                        betaChartCtx.lineTo(x, y);
                    }
                });
                betaChartCtx.stroke();
                betaChartCtx.globalAlpha = 1;
            });
            
            // Update legend
            const legendEl = document.getElementById('betaChartLegend');
            if (legendEl) {
                legendEl.innerHTML = '';
                Object.entries(data).forEach(([symbol, series]) => {
                    const currentBeta = series.data[series.data.length - 1]?.beta || series.beta;
                    legendEl.innerHTML += `
                        <div style="display: flex; align-items: center; gap: 4px;">
                            <div style="width: 12px; height: 2px; background: ${series.color};"></div>
                            <span style="color: var(--text-secondary);">${symbol}</span>
                            <span style="color: ${series.color}; font-weight: 600;">${currentBeta.toFixed(2)}</span>
                        </div>
                    `;
                });
            }
        }
        
        function viewConfluenceAnalysis(symbol) {
            // Open confluence analysis terminal page
            window.location.href = `/api/dashboard/confluence-analysis-page?symbol=${symbol}`;
        }

        // Performance-optimized update functions
        function updateDashboard(data) {
            // Update opportunities list
            const opportunitiesList = document.getElementById('opportunitiesList');
            const fragment = document.createDocumentFragment();
            
            if (data.opportunities && data.opportunities.length > 0) {
                data.opportunities.slice(0, 5).forEach(opp => {
                    const div = document.createElement('div');
                    div.innerHTML = createOpportunityCard(opp);
                    fragment.appendChild(div.firstChild);
                });
                opportunitiesList.innerHTML = '';
                opportunitiesList.appendChild(fragment);
            } else {
                opportunitiesList.innerHTML = createEmptyState('No opportunities available');
            }
        }

        function updateSignals(data) {
            const signalsList = document.getElementById('signalsList');
            const signalCount = document.getElementById('signalCount');
            
            // Handle both array and object with signals property
            const signals = Array.isArray(data) ? data : (data.signals || []);
            
            signalCount.textContent = signals.length;
            signalsList.innerHTML = '';
            
            if (signals.length > 0) {
                signals.forEach(signal => {
                    signalsList.innerHTML += createSignalCard(signal);
                });
            } else {
                signalsList.innerHTML = createEmptyState('No active signals');
            }
        }


        function updateAlpha(data) {
            const alphaList = document.getElementById('alphaList');
            alphaList.innerHTML = '';
            
            if (data.opportunities && data.opportunities.length > 0) {
                data.opportunities.forEach(alpha => {
                    alphaList.innerHTML += createAlphaCard(alpha);
                });
            } else {
                alphaList.innerHTML = createEmptyState('No alpha opportunities');
            }
        }

        function updateAlerts(data) {
            const alertsList = document.getElementById('alertsList');
            const alertCount = document.getElementById('alertCount');
            
            const alerts = data.alerts || [];
            alertCount.textContent = alerts.length;
            alertsList.innerHTML = '';
            
            if (alerts.length > 0) {
                alerts.forEach(alert => {
                    alertsList.innerHTML += createAlertCard(alert);
                });
            } else {
                alertsList.innerHTML = createEmptyState('No recent alerts');
            }
        }

        // Store symbols data for sorting
        let currentSymbolsData = [];
        
        function updateSymbols(data) {
            const symbolsList = document.getElementById('analyzedSymbolsList');
            const symbolsCount = document.getElementById('symbolsCount');
            
            const symbols = data.symbols || data.top_symbols || [];
            currentSymbolsData = symbols; // Store for sorting
            symbolsCount.textContent = symbols.length;
            
            renderSymbols(symbols);
            
            // Initialize Lucide icons for the new elements
            setTimeout(() => lucide.createIcons(), 100);
        }
        
        function renderSymbols(symbols) {
            const symbolsList = document.getElementById('analyzedSymbolsList');
            symbolsList.innerHTML = '';
            
            if (symbols.length > 0) {
                symbols.forEach(symbol => {
                    symbolsList.innerHTML += createAnalyzedSymbolItem(symbol);
                });
            } else {
                symbolsList.innerHTML = '<div class="empty-state" style="text-align: center; color: var(--text-secondary); padding: 20px; grid-column: 1 / -1;">No symbols data available</div>';
            }
        }
        
        function sortSymbols() {
            const sortBy = document.getElementById('sortSelector').value;
            let sortedSymbols = [...currentSymbolsData];
            
            switch(sortBy) {
                case 'score':
                    sortedSymbols.sort((a, b) => (b.confluence_score || b.score || 0) - (a.confluence_score || a.score || 0));
                    break;
                case 'change':
                    sortedSymbols.sort((a, b) => {
                        const changeA = parseFloat(a.price_change_percent || a.change_24h || 0);
                        const changeB = parseFloat(b.price_change_percent || b.change_24h || 0);
                        return changeB - changeA;
                    });
                    break;
                case 'volume':
                    sortedSymbols.sort((a, b) => {
                        const priceA = a.price || a.current_price || 0;
                        const priceB = b.price || b.current_price || 0;
                        const volumeA = a.volume_usd || a.quote_volume || ((a.volume || a.volume_24h || 0) * priceA) || 0;
                        const volumeB = b.volume_usd || b.quote_volume || ((b.volume || b.volume_24h || 0) * priceB) || 0;
                        return volumeB - volumeA;
                    });
                    break;
                case 'symbol':
                    sortedSymbols.sort((a, b) => (a.symbol || a).localeCompare(b.symbol || b));
                    break;
            }
            
            renderSymbols(sortedSymbols);
            setTimeout(() => lucide.createIcons(), 100);
        }
        
        function updateMarketOverview(data) {
            console.log('Market overview data:', data);  // Debug log
            
            // Market Regime - use safe extraction
            const regimeData = data.regime || data.market_regime || 'NEUTRAL';
            const regime = safeExtractValue(regimeData, 'NEUTRAL', true).toUpperCase();
            
            const regimeElement = document.getElementById('marketRegime');
            if (regimeElement) {
                regimeElement.textContent = regime;
            }
            
            // Market Breadth - Updated with visual display
            // Check for market_breadth or use gainers/losers from market_overview
            if (data.market_breadth) {
                const breadth = data.market_breadth;
                updateMarketBreadth(
                    breadth.up || breadth.up_count || 0,
                    breadth.down || breadth.down_count || 0
                );
            } else if (data.gainers !== undefined || data.losers !== undefined) {
                // Use gainers/losers counts from market_overview
                updateMarketBreadth(
                    data.gainers || 0,
                    data.losers || 0
                );
            } else {
                // Default fallback
                updateMarketBreadth(0, 0);
            }
            
            // Update regime colors
            if (regime === 'BULLISH') {
                regimeElement.style.background = 'rgba(76, 175, 80, 0.2)';
                regimeElement.style.color = 'var(--accent-positive)';
            } else if (regime === 'BEARISH') {
                regimeElement.style.background = 'rgba(244, 67, 54, 0.2)';
                regimeElement.style.color = 'var(--accent-negative)';
            } else {
                regimeElement.style.background = 'rgba(255, 191, 0, 0.1)';
                regimeElement.style.color = 'var(--text-primary)';
            }
            
            // Trend Strength
            const trendStrength = parseFloat(data.trend_strength || data.trend_score || 50);
            document.getElementById('trendStrength').textContent = Math.round(trendStrength);
            document.getElementById('trendStrengthBar').style.width = `${trendStrength}%`;
            
            // Update trend bar color based on strength
            const trendBar = document.getElementById('trendStrengthBar');
            if (trendStrength >= 70) {
                trendBar.style.background = 'var(--accent-positive)';
            } else if (trendStrength >= 30) {
                trendBar.style.background = 'var(--accent-warning)';
            } else {
                trendBar.style.background = 'var(--accent-negative)';
            }
            
            // Volatility
            const currentVol = parseFloat(data.volatility || data.current_volatility || 0);
            const avgVol = parseFloat(data.avg_volatility || data.volatility_average || 0);
            document.getElementById('currentVolatility').textContent = currentVol.toFixed(1) + '%';
            document.getElementById('avgVolatility').textContent = avgVol.toFixed(1) + '%';
            
            // Volatility descriptor
            const descriptorElement = document.getElementById('volatilityDescriptor');
            let descriptor = '';
            let descriptorColor = '';
            
            if (currentVol < 3) {
                descriptor = 'Very Low';
                descriptorColor = 'var(--accent-positive)';
            } else if (currentVol < 5) {
                descriptor = 'Low';
                descriptorColor = 'var(--accent-positive)';
            } else if (currentVol < 10) {
                descriptor = 'Normal';
                descriptorColor = 'var(--text-primary)';
            } else if (currentVol < 15) {
                descriptor = 'Elevated';
                descriptorColor = '#FFA500';
            } else if (currentVol < 20) {
                descriptor = 'High';
                descriptorColor = 'var(--accent-negative)';
            } else if (currentVol < 30) {
                descriptor = 'Very High';
                descriptorColor = 'var(--accent-negative)';
            } else {
                descriptor = 'Extreme';
                descriptorColor = '#FF0000';
            }
            
            descriptorElement.textContent = descriptor;
            descriptorElement.style.color = descriptorColor;
            
            // Color current volatility based on comparison
            const volElement = document.getElementById('currentVolatility');
            if (currentVol > avgVol * 1.2) {
                volElement.style.color = 'var(--accent-negative)';
            } else if (currentVol > avgVol) {
                volElement.style.color = 'var(--accent-warning)';
            } else {
                volElement.style.color = 'var(--accent-positive)';
            }
            
            // BTC Dominance
            const btcDom = parseFloat(data.btc_dominance || data.bitcoin_dominance || 0);
            document.getElementById('btcDominance').textContent = btcDom.toFixed(1) + '%';
            
            // Total Volume
            const totalVol = parseFloat(data.total_volume || data.volume_24h || 0);
            const formattedVolume = formatVolume(totalVol);
            document.getElementById('totalVolume').textContent = formattedVolume;
        }
        
        function formatVolume(volume) {
            if (volume >= 1e9) {
                return '$' + (volume / 1e9).toFixed(2) + 'B';
            } else if (volume >= 1e6) {
                return '$' + (volume / 1e6).toFixed(2) + 'M';
            } else if (volume >= 1e3) {
                return '$' + (volume / 1e3).toFixed(2) + 'K';
            } else {
                return '$' + volume.toFixed(2);
            }
        }
        
        function updateTopMovers(data) {
            const gainersList = document.getElementById('topGainersList');
            const losersList = document.getElementById('topLosersList');
            
            // Clear loading state
            gainersList.innerHTML = '';
            losersList.innerHTML = '';
            
            // Get gainers and losers
            const gainers = data.gainers || data.top_gainers || [];
            const losers = data.losers || data.top_losers || [];
            
            // Display top 5 gainers
            if (gainers.length > 0) {
                gainers.slice(0, 5).forEach(item => {
                    gainersList.innerHTML += createMoverItem(item, 'gainer');
                });
            } else {
                gainersList.innerHTML = '<div style="text-align: center; color: var(--text-secondary); font-size: 12px; padding: 10px;">No gainers found</div>';
            }
            
            // Display top 5 losers
            if (losers.length > 0) {
                losers.slice(0, 5).forEach(item => {
                    losersList.innerHTML += createMoverItem(item, 'loser');
                });
            } else {
                losersList.innerHTML = '<div style="text-align: center; color: var(--text-secondary); font-size: 12px; padding: 10px;">No losers found</div>';
            }
        }
        
        function createMoverItem(item, type) {
            const symbol = item.symbol || item;
            const displaySymbol = item.display_symbol || symbol;
            const change = parseFloat(item.change || item.change_24h || item.percentage || 0);
            const price = item.price || item.last || 0;
            const volume = item.volume || item.volume_24h || 0;
            
            const changeColor = type === 'gainer' ? 'var(--accent-positive)' : 'var(--accent-negative)';
            const changePrefix = type === 'gainer' ? '+' : '';
            
            // Use the cleaned display symbol (1000 prefix already removed from API)
            // Also remove USDT suffix for even cleaner display
            const finalDisplaySymbol = displaySymbol.replace('USDT', '').replace('USD', '');
            
            return `
                <div style="background: var(--bg-secondary); border: 1px solid var(--border-light); border-radius: 8px; padding: 10px; cursor: pointer;" onclick="viewSymbol('${symbol}')">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                        <span style="font-weight: 600; font-size: 13px; color: var(--text-primary);">${finalDisplaySymbol}</span>
                        <span style="font-weight: 700; font-size: 14px; color: ${changeColor};">${changePrefix}${Math.abs(change).toFixed(2)}%</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="font-size: 11px; color: var(--text-secondary);">$${price > 100 ? price.toFixed(2) : price.toFixed(4)}</span>
                        <span style="font-size: 10px; color: var(--text-secondary);">Vol: ${(volume / 1e6).toFixed(1)}M</span>
                    </div>
                </div>
            `;
        }

        // Component creators
        function createOpportunityCard(opp) {
            const scoreClass = opp.score >= 80 ? 'score-high' : opp.score >= 60 ? 'score-medium' : 'score-low';
            return `
                <div class="opportunity-item" onclick="viewOpportunity('${opp.symbol}')">
                    <div class="opportunity-header">
                        <div class="signal-symbol">${opp.symbol}</div>
                        <div class="signal-score ${scoreClass}">${opp.score}</div>
                    </div>
                    <div class="opportunity-metrics">
                        <div class="metric-item">
                            <div class="metric-value">${opp.momentum || 'N/A'}</div>
                            <div class="metric-label">Momentum</div>
                        </div>
                        <div class="metric-item">
                            <div class="metric-value">${opp.volume || 'N/A'}</div>
                            <div class="metric-label">Volume</div>
                        </div>
                    </div>
                    <div class="action-buttons">
                        <button class="action-btn btn-primary" onclick="window.open('https://www.bybit.com/trade/usdt/${symbol}', '_blank')">Trade</button>
                        <button class="action-btn btn-secondary" onclick="viewConfluenceAnalysis('${symbol}')">Analyze</button>
                    </div>
                </div>
            `;
        }

        function createSignalCard(signal) {
            // Extract signal details from dashboard integration format with safe extraction
            const symbol = safeExtractValue(signal.symbol, 'N/A');
            const score = parseFloat(signal.score || signal.confidence || 0);
            const type = safeExtractValue(signal.type, 'NEUTRAL').toUpperCase();
            const strength = safeExtractValue(signal.strength, 'weak');
            const price = parseFloat(signal.price || 0);
            const change = parseFloat(signal.change_24h || 0);
            const volume = parseFloat(signal.volume || 0);
            const timestamp = signal.timestamp ? new Date(signal.timestamp).toLocaleTimeString() : 'now';
            
            const changeClass = change > 0 ? 'change-positive' : change < 0 ? 'change-negative' : 'change-neutral';
            const changePrefix = change > 0 ? '+' : '';
            
            return `
                <div class="signal-card">
                    <div class="signal-info">
                        <div class="signal-symbol">${symbol}</div>
                        <div class="signal-details">
                            ${type} ${strength.toUpperCase()} â€¢ $${price.toFixed(2)} (${changePrefix}${change.toFixed(2)}%)
                        </div>
                        <div class="signal-details" style="font-size: 12px; margin-top: 4px;">
                            Volume: ${(volume / 1000000).toFixed(2)}M â€¢ ${timestamp}
                        </div>
                    </div>
                    <div class="signal-score ${getScoreClass(score)}">
                        ${score.toFixed(0)}
                    </div>
                </div>
            `;
        }


        function createAlphaCard(alpha) {
            return `
                <div class="opportunity-item" onclick="viewAlpha('${alpha.id}')">
                    <div class="opportunity-header">
                        <div class="signal-symbol">${alpha.type}</div>
                        <div class="card-badge" style="background: rgba(76, 175, 80, 0.2); color: var(--accent-positive);">
                            ${alpha.potential}%
                        </div>
                    </div>
                    <div class="signal-details" style="margin: 8px 0;">
                        ${alpha.description}
                    </div>
                    <div class="action-buttons">
                        <button class="action-btn btn-primary">Execute</button>
                    </div>
                </div>
            `;
        }

        function createAlertCard(alert) {
            // Extract alert data from various formats
            const alertType = alert.alert_type || alert.type || 'system';
            const severity = alert.severity || 'INFO';
            const symbol = alert.symbol || alert.title || 'System';
            const message = alert.message || alert.description || 'Alert triggered';
            
            // Try to extract key metrics from alert data
            const confluenceScore = alert.confluence_score || alert.score || null;
            const price = alert.price || alert.current_price || null;
            const volume = alert.volume || null;
            const details = alert.details || {};
            
            const alertTypeColors = {
                'signal': 'var(--accent-positive)',
                'high_confluence': 'var(--accent-positive)',
                'whale': 'var(--accent-warning)',
                'whale_activity': 'var(--accent-warning)',
                'liquidation': 'var(--accent-negative)',
                'liquidation_cascade': 'var(--accent-negative)',
                'manipulation': 'var(--accent-negative)',
                'system': 'var(--text-secondary)',
                'error': 'var(--accent-negative)',
                'CRITICAL': 'var(--accent-negative)',
                'WARNING': 'var(--accent-warning)',
                'INFO': 'var(--text-primary)'
            };
            
            const color = alertTypeColors[alertType] || alertTypeColors[severity] || 'var(--text-primary)';
            const timestamp = alert.timestamp ? new Date(alert.timestamp).toLocaleTimeString() : new Date().toLocaleTimeString();
            
            // Build detailed message
            let detailsHtml = '';
            if (confluenceScore !== null) {
                detailsHtml += `Score: ${confluenceScore} â€¢ `;
            }
            if (price !== null) {
                detailsHtml += `$${typeof price === 'number' ? price.toFixed(2) : price} â€¢ `;
            }
            if (volume !== null) {
                detailsHtml += `Vol: ${(volume / 1000000).toFixed(2)}M â€¢ `;
            }
            
            return `
                <div class="signal-card">
                    <div class="signal-info">
                        <div class="signal-symbol" style="color: ${color};">${symbol}</div>
                        <div class="signal-details">${message}</div>
                        ${detailsHtml ? `<div class="signal-details" style="font-size: 12px; margin-top: 4px;">${detailsHtml}${timestamp}</div>` : `<div class="signal-details" style="font-size: 12px;">${timestamp}</div>`}
                    </div>
                    <div class="card-badge" style="background: rgba(255, 191, 0, 0.1); color: ${color};">
                        ${(alertType || severity).toUpperCase().replace('_', ' ')}
                    </div>
                </div>
            `;
        }

        function createAnalyzedSymbolItem(symbol) {
            // Handle different data formats
            const symbolName = symbol.symbol || symbol;
            const price = symbol.price || symbol.current_price || 0;
            const confluenceScore = symbol.confluence_score || symbol.score || 50;
            const change = symbol.price_change_percent || symbol.change_24h || 0;
            const changeValue = typeof change === 'string' ? parseFloat(change) : change;
            const volume = symbol.volume || symbol.volume_24h || 0;
            const volume_usd = symbol.volume_usd || symbol.quote_volume || symbol.turnover_24h || (volume * price) || 0;
            const high_24h = symbol.high_24h || symbol.high || 0;
            const low_24h = symbol.low_24h || symbol.low || 0;
            
            // Extract component scores if available
            const components = symbol.components || symbol.results || {};
            const reliability = symbol.reliability || 0;
            const signalType = symbol.signal_type || symbol.type || 'NEUTRAL';
            const signalStrength = symbol.signal_strength || symbol.strength || 'weak';
            const timestamp = symbol.timestamp || Date.now();
            
            // Generate unique ID for expand/collapse
            const cardId = `card_${symbolName.replace(/[^a-zA-Z0-9]/g, '_')}`;
            
            // Determine score color and get trend icon
            let scoreColor = 'var(--text-secondary)';
            let scoreBg = 'rgba(255, 255, 255, 0.05)';
            let scoreLevel = 'WEAK';
            let trendIcon = 'minus';
            
            if (confluenceScore >= 70) {
                scoreColor = 'var(--accent-positive)';
                scoreBg = 'rgba(76, 175, 80, 0.1)';
                scoreLevel = 'STRONG';
                trendIcon = 'trending-up';
            } else if (confluenceScore >= 50) {
                scoreColor = 'var(--accent-warning)';
                scoreBg = 'rgba(255, 191, 0, 0.1)';
                scoreLevel = 'MODERATE';
                trendIcon = changeValue > 0 ? 'trending-up' : 'trending-down';
            } else {
                scoreColor = 'var(--accent-negative)';
                scoreBg = 'rgba(244, 67, 54, 0.1)';
                scoreLevel = 'WEAK';
                trendIcon = 'trending-down';
            }
            
            // Format symbol name (remove 1000 prefix and USDT suffix for display)
            let displaySymbol = symbolName;
            if (displaySymbol.startsWith('1000') && displaySymbol.length > 4) {
                displaySymbol = displaySymbol.substring(4);
            }
            displaySymbol = displaySymbol.replace('USDT', '').replace('USD', '');
            const changePrefix = changeValue > 0 ? '+' : '';
            const changeColor = changeValue >= 0 ? 'var(--accent-positive)' : 'var(--accent-negative)';
            
            // Format turnover/USD volume
            let turnoverDisplay = '';
            if (volume_usd > 0) {
                turnoverDisplay = volume_usd > 1e9 ? '$' + (volume_usd/1e9).toFixed(2) + 'B' : 
                                 volume_usd > 1e6 ? '$' + (volume_usd/1e6).toFixed(1) + 'M' : 
                                 volume_usd > 1e3 ? '$' + (volume_usd/1e3).toFixed(1) + 'K' : 
                                 '$' + volume_usd.toFixed(0);
            }
            
            // Calculate price range percentage
            const priceRange = high_24h > 0 && low_24h > 0 ? ((high_24h - low_24h) / low_24h * 100).toFixed(2) : 0;
            
            // Component scores for mini visualization
            const componentScores = {
                technical: components.technical || 50,
                volume: components.volume || 50,
                orderflow: components.orderflow || 50,
                sentiment: components.sentiment || 50,
                orderbook: components.orderbook || 50,
                price_structure: components.price_structure || 50
            };
            
            return `
                <div class="symbol-card" id="${cardId}" style="background: var(--bg-secondary); border: 1px solid var(--border-light); border-radius: 14px; cursor: pointer; transition: all 0.2s ease; position: relative; overflow: hidden;">
                    <!-- Score indicator bar -->
                    <div style="position: absolute; top: 0; left: 0; right: 0; height: 4px; background: ${scoreColor}; opacity: 0.9;"></div>
                    
                    <!-- Main card content (always visible) -->
                    <div style="padding: 14px;" onclick="toggleCardExpansion('${cardId}')">
                        <!-- Header with symbol and score -->
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <div style="display: flex; align-items: center; gap: 6px;">
                                <span style="font-weight: 700; font-size: 17px; color: var(--text-primary);">${displaySymbol}</span>
                                <i data-lucide="${trendIcon}" style="width: 15px; height: 15px; color: ${scoreColor};"></i>
                            </div>
                            <div style="background: ${scoreBg}; padding: 4px 8px; border-radius: 8px;">
                                <span style="font-size: 14px; font-weight: 700; color: ${scoreColor};">${Math.round(confluenceScore)}</span>
                            </div>
                        </div>
                        
                        <!-- Price and change row -->
                        <div style="display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 10px;">
                            <div style="font-size: 16px; font-weight: 600; color: var(--text-primary);">
                                $${price > 100 ? price.toFixed(2) : price < 1 ? price.toFixed(4) : price.toFixed(3)}
                            </div>
                            <div style="font-size: 14px; font-weight: 600; color: ${changeColor};">
                                ${changePrefix}${Math.abs(changeValue).toFixed(2)}%
                            </div>
                        </div>
                        
                        <!-- Turnover and range row -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 10px;">
                            <div style="padding: 6px; background: rgba(0, 0, 0, 0.2); border-radius: 6px;">
                                <div style="font-size: 9px; color: var(--text-secondary); text-transform: uppercase;">Turnover</div>
                                <div style="font-size: 12px; font-weight: 600; color: var(--text-primary);">${turnoverDisplay || 'N/A'}</div>
                            </div>
                            <div style="padding: 6px; background: rgba(0, 0, 0, 0.2); border-radius: 6px;">
                                <div style="font-size: 9px; color: var(--text-secondary); text-transform: uppercase;">24H Range</div>
                                <div style="font-size: 12px; font-weight: 600; color: var(--text-primary);">${priceRange}%</div>
                            </div>
                        </div>
                        
                        <!-- Component breakdown mini bars -->
                        <div style="display: flex; gap: 2px; margin-bottom: 8px;">
                            ${Object.entries(componentScores).map(([comp, score]) => {
                                const height = Math.max(10, (score / 100) * 30);
                                const barColor = score >= 70 ? 'var(--accent-positive)' : score >= 30 ? 'var(--accent-warning)' : 'var(--accent-negative)';
                                return `<div style="flex: 1; background: rgba(255, 255, 255, 0.05); border-radius: 2px; height: 30px; position: relative; overflow: hidden;">
                                    <div style="position: absolute; bottom: 0; width: 100%; height: ${height}px; background: ${barColor}; opacity: 0.8;"></div>
                                </div>`;
                            }).join('')}
                        </div>
                        
                        <!-- Expand indicator -->
                        <div style="display: flex; justify-content: center; margin-top: 8px;">
                            <i data-lucide="chevron-down" style="width: 16px; height: 16px; color: var(--text-secondary); transition: transform 0.3s;" id="${cardId}_chevron"></i>
                        </div>
                    </div>
                    
                    <!-- Expanded content (hidden by default) -->
                    <div id="${cardId}_expanded" style="display: none; padding: 0 14px 14px 14px; border-top: 1px solid var(--border-light);">
                        <!-- Component scores breakdown -->
                        <div style="margin-bottom: 12px;">
                            <h4 style="font-size: 12px; font-weight: 600; color: var(--text-primary); margin-bottom: 8px; text-transform: uppercase;">Component Breakdown</h4>
                            ${Object.entries(componentScores).map(([comp, score]) => {
                                const compColor = score >= 70 ? 'var(--accent-positive)' : score >= 30 ? 'var(--accent-warning)' : 'var(--accent-negative)';
                                const compName = comp.replace('_', ' ').charAt(0).toUpperCase() + comp.replace('_', ' ').slice(1);
                                return `
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                                    <span style="font-size: 11px; color: var(--text-secondary);">${compName}</span>
                                    <div style="display: flex; align-items: center; gap: 6px;">
                                        <div style="width: 60px; height: 4px; background: rgba(255, 255, 255, 0.1); border-radius: 2px; overflow: hidden;">
                                            <div style="width: ${score}%; height: 100%; background: ${compColor};"></div>
                                        </div>
                                        <span style="font-size: 11px; font-weight: 600; color: ${compColor}; min-width: 25px; text-align: right;">${Math.round(score)}</span>
                                    </div>
                                </div>`;
                            }).join('')}
                        </div>
                        
                        <!-- Signal details -->
                        <div style="margin-bottom: 12px;">
                            <h4 style="font-size: 12px; font-weight: 600; color: var(--text-primary); margin-bottom: 8px; text-transform: uppercase;">Signal Details</h4>
                            <div style="padding: 8px; background: rgba(0, 0, 0, 0.2); border-radius: 6px; text-align: center;">
                                <div style="font-size: 9px; color: var(--text-secondary); margin-bottom: 4px;">Current Signal</div>
                                <div style="font-size: 14px; font-weight: 700; color: ${signalType === 'BUY' ? 'var(--accent-positive)' : signalType === 'SELL' ? 'var(--accent-negative)' : 'var(--text-secondary)'};">${signalType}</div>
                            </div>
                        </div>
                        
                        <!-- Reliability and timestamp -->
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <span style="font-size: 9px; color: var(--text-secondary);">Reliability: </span>
                                <span style="font-size: 11px; font-weight: 600; color: ${reliability >= 80 ? 'var(--accent-positive)' : reliability >= 60 ? 'var(--accent-warning)' : 'var(--accent-negative)'};">${reliability.toFixed(1)}%</span>
                            </div>
                            <div style="font-size: 9px; color: var(--text-secondary);">
                                ${new Date(timestamp).toLocaleTimeString()}
                            </div>
                        </div>
                        
                        <!-- Action buttons -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 12px;">
                            <button onclick="viewDetailedAnalysis('${symbolName}')" style="padding: 8px; background: var(--accent-primary); border: none; border-radius: 6px; color: var(--bg-primary); font-size: 12px; font-weight: 600; cursor: pointer;">
                                <i data-lucide="chart-line" style="width: 12px; height: 12px; display: inline-block; margin-right: 4px;"></i>
                                Analysis
                            </button>
                            <button onclick="viewAlerts('${symbolName}')" style="padding: 8px; background: rgba(255, 191, 0, 0.2); border: 1px solid var(--border-light); border-radius: 6px; color: var(--text-primary); font-size: 12px; font-weight: 600; cursor: pointer;">
                                <i data-lucide="bell" style="width: 12px; height: 12px; display: inline-block; margin-right: 4px;"></i>
                                Alerts
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function createSymbolItem(symbol) {
            // Handle different data formats
            const symbolName = symbol.symbol || symbol;
            const price = symbol.price || symbol.current_price || 0;
            const confluenceScore = symbol.confluence_score || symbol.score || 50;
            const change = symbol.price_change_percent || symbol.change_24h || 0;
            const changeValue = typeof change === 'string' ? parseFloat(change) : change;
            const changeClass = changeValue > 0 ? 'change-positive' : changeValue < 0 ? 'change-negative' : 'change-neutral';
            const changePrefix = changeValue > 0 ? '+' : '';
            
            // Determine score color
            let scoreColor = 'var(--text-secondary)';
            if (confluenceScore >= 70) {
                scoreColor = 'var(--accent-positive)';
            } else if (confluenceScore >= 30 && confluenceScore < 70) {
                scoreColor = 'var(--accent-warning)';
            } else {
                scoreColor = 'var(--accent-negative)';
            }
            
            // Format price based on value
            const formattedPrice = price > 100 ? price.toFixed(2) : price > 1 ? price.toFixed(4) : price.toFixed(6);
            
            return `
                <div class="symbol-item" onclick="viewSymbol('${symbolName}')">
                    <div class="symbol-info">
                        <div>
                            <div class="symbol-name">${symbolName.replace('USDT', '')}</div>
                            <div class="symbol-price">$${formattedPrice}</div>
                        </div>
                    </div>
                    <div class="symbol-metrics">
                        <div class="confluence-score">
                            <div class="score-value" style="color: ${scoreColor}">${confluenceScore}</div>
                            <div class="score-label">Score</div>
                        </div>
                        <div class="symbol-change ${changeClass}">
                            ${changePrefix}${changeValue.toFixed(2)}%
                        </div>
                    </div>
                </div>
            `;
        }

        function createEmptyState(message) {
            return `
                <div class="empty-state">
                    <i data-lucide="inbox" class="empty-icon"></i>
                    <div class="empty-title">No Data</div>
                    <div class="empty-text">${message}</div>
                </div>
            `;
        }

        // Helper functions
        function getScoreClass(score) {
            if (score >= 80) return 'score-high';
            if (score >= 60) return 'score-medium';
            return 'score-low';
        }

        function getScoreColor(score) {
            if (score >= 80) return 'var(--accent-positive)';
            if (score >= 60) return 'var(--accent-warning)';
            return 'var(--accent-negative)';
        }

        // Debounce function for performance
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        const debouncedRefresh = debounce(() => {
            const activeTab = document.querySelector('.nav-item.active');
            const tabName = activeTab.querySelector('.nav-label').textContent.toLowerCase();
            loadTabData(tabName);
            
            // Show refresh feedback
            pullToRefresh.innerHTML = '<i data-lucide="check" style="width: 16px; height: 16px; margin-right: 8px;"></i><span>Updated</span>';
            setTimeout(() => {
                pullToRefresh.innerHTML = '<i data-lucide="refresh-cw" style="width: 16px; height: 16px; margin-right: 8px;"></i><span>Pull to refresh</span>';
                lucide.createIcons();
            }, 1000);
        }, 300);

        function refreshData() {
            debouncedRefresh();
        }

        function toggleSettings() {
            // Implement settings panel
            alert('Settings panel coming soon!');
        }

        function viewOpportunity(symbol) {
            // Implement opportunity detail view
            console.log('View opportunity:', symbol);
        }


        function viewAlpha(id) {
            // Implement alpha detail view
            console.log('View alpha:', id);
        }

        function viewSymbol(symbol) {
            // Navigate to signals tab with symbol filter
            switchTab('signals');
            // TODO: Filter signals by symbol
            console.log('View symbol:', symbol);
        }

        // Card expansion/collapse functionality
        function toggleCardExpansion(cardId) {
            const expandedContent = document.getElementById(`${cardId}_expanded`);
            const chevron = document.getElementById(`${cardId}_chevron`);
            
            if (expandedContent.style.display === 'none') {
                // Expand
                expandedContent.style.display = 'block';
                chevron.style.transform = 'rotate(180deg)';
                
                // Smooth animation
                expandedContent.style.opacity = '0';
                expandedContent.style.maxHeight = '0';
                setTimeout(() => {
                    expandedContent.style.transition = 'all 0.3s ease';
                    expandedContent.style.opacity = '1';
                    expandedContent.style.maxHeight = '500px';
                }, 10);
            } else {
                // Collapse
                expandedContent.style.opacity = '0';
                expandedContent.style.maxHeight = '0';
                chevron.style.transform = 'rotate(0deg)';
                
                setTimeout(() => {
                    expandedContent.style.display = 'none';
                    expandedContent.style.transition = '';
                }, 300);
            }
            
            // Prevent event bubbling
            event.stopPropagation();
        }
        
        function viewDetailedAnalysis(symbol) {
            // Navigate to detailed analysis page
            console.log('View detailed analysis for:', symbol);
            window.location.href = `/api/dashboard/confluence-analysis-page?symbol=${symbol}`;
            event.stopPropagation();
        }
        
        function viewAlerts(symbol) {
            // Navigate to alerts for this symbol
            console.log('View alerts for:', symbol);
            // Switch to alerts tab and filter by symbol
            switchTab('alerts');
            // TODO: Implement symbol filtering in alerts
            event.stopPropagation();
        }
        
        // WebSocket connection for real-time updates
        let ws;
        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            ws = new WebSocket(`${protocol}//${window.location.host}/ws`);
            
            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                handleRealtimeUpdate(data);
            };
            
            ws.onerror = (error) => {
                console.error('WebSocket error:', error);
            };
            
            ws.onclose = () => {
                // Reconnect after 5 seconds
                setTimeout(connectWebSocket, 5000);
            };
        }

        function handleRealtimeUpdate(data) {
            // Handle real-time updates based on data type
            if (data.type === 'signal') {
                // Update signals if on signals tab
                if (document.getElementById('signalsTab').classList.contains('active')) {
                    loadSignalsData();
                }
            } else if (data.type === 'price_update' || data.type === 'ticker') {
                // Update symbols if on dashboard tab
                if (document.getElementById('dashboardTab').classList.contains('active')) {
                    fetch('/api/dashboard/symbols')
                        .then(response => response.json())
                        .then(data => updateSymbols(data))
                        .catch(error => console.error('Error updating symbols:', error));
                }
            }
        }

        // Intersection Observer for performance
        const observerOptions = {
            root: null,
            rootMargin: '50px',
            threshold: 0.1
        };

        const intersectionObserver = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    // Load content when it comes into view
                    const element = entry.target;
                    if (element.dataset.lazy === 'true') {
                        // Trigger lazy loading here
                        element.dataset.lazy = 'false';
                    }
                }
            });
        }, observerOptions);

        // Initialize on load with performance optimizations
        document.addEventListener('DOMContentLoaded', () => {
            // Use requestIdleCallback for non-critical tasks
            if ('requestIdleCallback' in window) {
                requestIdleCallback(() => {
                    connectWebSocket();
                });
            } else {
                setTimeout(connectWebSocket, 100);
            }
            
            loadDashboardData();
            
            // Debounced icon refresh
            const debouncedIconRefresh = debounce(() => {
                lucide.createIcons();
            }, 100);
            
            // Optimize mutation observer
            const observer = new MutationObserver(debouncedIconRefresh);
            observer.observe(document.body, {
                childList: true,
                subtree: true,
                attributes: false,
                characterData: false
            });
        });

        // Handle visibility change
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden) {
                refreshData();
            }
        });

        // Service Worker for offline support
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js').catch(() => {
                console.log('Service Worker registration failed');
            });
        }
        // Settings Management
        let autoRefreshInterval = null;
        let userSettings = {
            refreshRate: 60000,
            defaultSort: 'score',
            symbolsLimit: 20,
            minConfluence: 70,
            soundAlerts: false,
            visibleCards: {
                marketOverview: true,
                topMovers: true,
                opportunities: true
            }
        };

        function toggleSettings() {
            const panel = document.getElementById('settingsPanel');
            const overlay = document.getElementById('settingsOverlay');
            const isOpen = panel.style.right === '0px';
            
            if (isOpen) {
                panel.style.right = '-100%';
                overlay.style.opacity = '0';
                overlay.style.visibility = 'hidden';
            } else {
                panel.style.right = '0px';
                overlay.style.opacity = '1';
                overlay.style.visibility = 'visible';
                lucide.createIcons();
            }
        }

        function updateRefreshRate() {
            const rate = parseInt(document.getElementById('refreshRate').value);
            userSettings.refreshRate = rate;
            saveSettings();
            setupAutoRefresh();
        }

        function updateDefaultSort() {
            const sort = document.getElementById('defaultSort').value;
            userSettings.defaultSort = sort;
            document.getElementById('sortSelector').value = sort;
            sortSymbols();
            saveSettings();
        }

        function updateSymbolsLimit() {
            const limit = parseInt(document.getElementById('symbolsLimit').value);
            userSettings.symbolsLimit = limit;
            saveSettings();
            loadDashboardData();
        }

        function updateMinConfluence() {
            const min = parseInt(document.getElementById('minConfluence').value);
            userSettings.minConfluence = min;
            saveSettings();
        }

        function updateSoundAlerts() {
            const enabled = document.getElementById('soundAlerts').checked;
            userSettings.soundAlerts = enabled;
            saveSettings();
        }

        function toggleCard(cardType) {
            const checkbox = document.getElementById(`show${cardType.charAt(0).toUpperCase() + cardType.slice(1)}`);
            userSettings.visibleCards[cardType] = checkbox.checked;
            saveSettings();
            applyCardVisibility();
        }

        function applyCardVisibility() {
            const cards = document.querySelectorAll('.mobile-card');
            cards.forEach(card => {
                const title = card.querySelector('.card-title')?.textContent;
                if (title?.includes('Market Overview') && !userSettings.visibleCards.marketOverview) {
                    card.style.display = 'none';
                } else if (title?.includes('Top Movers') && !userSettings.visibleCards.topMovers) {
                    card.style.display = 'none';
                } else if (title?.includes('Top Opportunities') && !userSettings.visibleCards.opportunities) {
                    card.style.display = 'none';
                } else {
                    card.style.display = 'block';
                }
            });
        }

        function resetSettings() {
            userSettings = {
                refreshRate: 60000,
                defaultSort: 'score',
                symbolsLimit: 20,
                minConfluence: 70,
                soundAlerts: false,
                visibleCards: {
                    marketOverview: true,
                    topMovers: true,
                    opportunities: true
                }
            };
            loadSettingsUI();
            saveSettings();
            setupAutoRefresh();
            applyCardVisibility();
        }

        function exportSettings() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(userSettings, null, 2));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "virtuoso-settings.json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }

        function saveSettings() {
            localStorage.setItem('virtuoso-settings', JSON.stringify(userSettings));
        }

        function loadSettings() {
            const saved = localStorage.getItem('virtuoso-settings');
            if (saved) {
                userSettings = { ...userSettings, ...JSON.parse(saved) };
            }
            loadSettingsUI();
        }

        function loadSettingsUI() {
            document.getElementById('refreshRate').value = userSettings.refreshRate;
            document.getElementById('defaultSort').value = userSettings.defaultSort;
            document.getElementById('symbolsLimit').value = userSettings.symbolsLimit;
            document.getElementById('minConfluence').value = userSettings.minConfluence;
            document.getElementById('soundAlerts').checked = userSettings.soundAlerts;
            
            document.getElementById('showMarketOverview').checked = userSettings.visibleCards.marketOverview;
            document.getElementById('showTopMovers').checked = userSettings.visibleCards.topMovers;
            document.getElementById('showOpportunities').checked = userSettings.visibleCards.opportunities;
            
            document.getElementById('sortSelector').value = userSettings.defaultSort;
        }

        function setupAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
            }
            
            if (userSettings.refreshRate > 0) {
                autoRefreshInterval = setInterval(() => {
                    const activeTab = document.querySelector('.nav-item.active');
                    if (activeTab) {
                        const onclick = activeTab.getAttribute('onclick');
                        const tabName = onclick.match(/'([^']+)'/)[1];
                        loadTabData(tabName);
                    }
                }, userSettings.refreshRate);
            }
        }
    </script>

        <!-- Cache Status Indicator removed -->
        
</body>
</html>