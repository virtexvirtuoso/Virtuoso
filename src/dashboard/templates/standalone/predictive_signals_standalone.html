<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bitcoin-Altcoin Predictive Analytics | Virtuoso Trading</title>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;600;700&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Virtuoso Brand Colors */
            --neon-amber: #fbbf24;
            --neon-cyan: #06B6D4;
            --neon-red: #ff0066;

            /* Dark Mode */
            --dark-bg-primary: #0a0a0a;
            --dark-bg-secondary: #111111;
            --dark-border: #222222;
            --dark-text-primary: #e0e0e0;
            --dark-text-secondary: #9ca3af;
            --dark-text-tertiary: #6b7280;

            /* Semantic Colors */
            --success: #10b981;
            --error: #ef4444;
            --warning: #f59e0b;
            --info: #3b82f6;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--dark-bg-primary);
            color: var(--dark-text-primary);
            padding: 20px;
            min-height: 100vh;
            line-height: 1.6;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: var(--dark-bg-secondary);
            border-radius: 12px;
            border: 1px solid var(--dark-border);
            transition: all 0.3s ease;
        }

        .header:hover {
            border-color: var(--neon-cyan);
            box-shadow: 0 0 20px rgba(6, 182, 212, 0.15);
        }

        .header h1 {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 2.5em;
            color: var(--dark-text-primary);
            margin-bottom: 10px;
            font-weight: 600;
        }

        .header h1 span {
            color: var(--neon-amber);
            text-shadow: 0 0 8px rgba(251, 191, 36, 0.4);
        }

        .header .subtitle {
            color: var(--dark-text-secondary);
            font-size: 1.1em;
            font-family: 'Inter', sans-serif;
        }

        .controls {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            flex-wrap: wrap;
            justify-content: center;
            padding: 20px;
            background: var(--dark-bg-secondary);
            border-radius: 12px;
            border: 1px solid var(--dark-border);
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .control-group label {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.75em;
            color: var(--dark-text-secondary);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        select, input[type="range"] {
            padding: 10px 15px;
            background: var(--dark-bg-primary);
            border: 1px solid var(--dark-border);
            border-radius: 8px;
            color: var(--dark-text-primary);
            font-family: 'Inter', sans-serif;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        select:hover, select:focus {
            border-color: var(--neon-cyan);
            box-shadow: 0 0 15px rgba(6, 182, 212, 0.2);
            outline: none;
        }

        button {
            padding: 10px 20px;
            background: transparent;
            border: 1px solid var(--dark-border);
            border-radius: 8px;
            color: var(--dark-text-secondary);
            font-family: 'IBM Plex Mono', monospace;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        button:hover {
            border-color: var(--neon-cyan);
            color: var(--neon-cyan);
            box-shadow: 0 0 10px rgba(6, 182, 212, 0.2);
        }

        button:active {
            transform: scale(0.98);
        }

        .overview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--dark-bg-secondary);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid var(--dark-border);
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-4px);
            border-color: var(--neon-cyan);
            box-shadow: 0 0 15px rgba(6, 182, 212, 0.15);
        }

        .stat-card .label {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.75em;
            color: var(--dark-text-secondary);
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-weight: 600;
        }

        .stat-card .value {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 2em;
            font-weight: 700;
            color: var(--neon-cyan);
        }

        .stat-card .subvalue {
            font-size: 0.9em;
            color: var(--dark-text-tertiary);
            margin-top: 5px;
        }

        .volatility-badge {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            font-family: 'IBM Plex Mono', monospace;
            font-weight: 700;
            font-size: 0.75em;
            margin-top: 10px;
            text-transform: uppercase;
        }

        .volatility-normal {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .volatility-elevated {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning);
            border: 1px solid rgba(245, 158, 11, 0.3);
        }

        .volatility-spike {
            background: rgba(239, 68, 68, 0.1);
            color: var(--error);
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .section {
            margin-bottom: 30px;
        }

        .section-title {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 1.3em;
            margin-bottom: 15px;
            color: var(--neon-cyan);
            padding-left: 15px;
            border-left: 4px solid var(--neon-cyan);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .chart-container {
            background: var(--dark-bg-secondary);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid var(--dark-border);
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }

        .chart-container:hover {
            border-color: var(--dark-border);
            box-shadow: 0 0 10px rgba(251, 191, 36, 0.05);
        }

        .chart-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .table-container {
            background: var(--dark-bg-secondary);
            border-radius: 12px;
            border: 1px solid var(--dark-border);
            overflow: hidden;
            margin-bottom: 30px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background: rgba(6, 182, 212, 0.05);
        }

        th {
            padding: 15px;
            text-align: left;
            font-family: 'IBM Plex Mono', monospace;
            font-weight: 600;
            font-size: 0.75em;
            color: var(--neon-cyan);
            cursor: pointer;
            user-select: none;
            transition: all 0.2s ease;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        th:hover {
            background: rgba(6, 182, 212, 0.08);
        }

        th.sortable::after {
            content: ' â‡…';
            opacity: 0.5;
        }

        th.sorted-asc::after {
            content: ' â†‘';
            opacity: 1;
        }

        th.sorted-desc::after {
            content: ' â†“';
            opacity: 1;
        }

        td {
            padding: 15px;
            border-bottom: 1px solid var(--dark-border);
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.85em;
        }

        tr:hover {
            background: rgba(6, 182, 212, 0.03);
        }

        .stability-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 12px;
            font-family: 'IBM Plex Mono', monospace;
            font-weight: 600;
            font-size: 0.7em;
            text-transform: uppercase;
        }

        .stability-very-stable {
            background: rgba(6, 182, 212, 0.1);
            color: var(--neon-cyan);
            border: 1px solid rgba(6, 182, 212, 0.3);
        }

        .stability-stable {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .stability-moderate {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning);
            border: 1px solid rgba(245, 158, 11, 0.3);
        }

        .stability-unstable {
            background: rgba(239, 68, 68, 0.1);
            color: var(--error);
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .signal-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 12px;
            font-family: 'IBM Plex Mono', monospace;
            font-weight: 700;
            font-size: 0.7em;
            text-transform: uppercase;
        }

        .signal-long {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .signal-short {
            background: rgba(239, 68, 68, 0.1);
            color: var(--error);
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .signal-none {
            background: rgba(107, 114, 128, 0.1);
            color: var(--dark-text-secondary);
            border: 1px solid rgba(107, 114, 128, 0.3);
        }

        .actionable-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .trade-card {
            background: var(--dark-bg-secondary);
            border-radius: 12px;
            padding: 20px;
            border: 2px solid;
            transition: all 0.3s ease;
        }

        .trade-card.long {
            border-color: var(--success);
        }

        .trade-card.short {
            border-color: var(--error);
        }

        .trade-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 0 25px rgba(6, 182, 212, 0.2);
        }

        .trade-card.long:hover {
            box-shadow: 0 0 25px rgba(16, 185, 129, 0.3);
        }

        .trade-card.short:hover {
            box-shadow: 0 0 25px rgba(239, 68, 68, 0.3);
        }

        .trade-card .symbol {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 1.8em;
            font-weight: 700;
            margin-bottom: 10px;
            color: var(--neon-cyan);
        }

        .trade-card .direction {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            font-family: 'IBM Plex Mono', monospace;
            font-weight: 700;
            font-size: 0.9em;
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .trade-card .direction.long {
            background: rgba(16, 185, 129, 0.2);
            color: var(--success);
            border: 1px solid var(--success);
        }

        .trade-card .direction.short {
            background: rgba(239, 68, 68, 0.2);
            color: var(--error);
            border: 1px solid var(--error);
        }

        .trade-card .metrics {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid var(--dark-border);
        }

        .trade-card .metric {
            text-align: center;
        }

        .trade-card .metric-label {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.65em;
            color: var(--dark-text-secondary);
            margin-bottom: 4px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .trade-card .metric-value {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 1.2em;
            font-weight: 700;
            color: var(--dark-text-primary);
        }

        .loading {
            text-align: center;
            padding: 60px;
            font-size: 1.2em;
            color: var(--dark-text-secondary);
        }

        .spinner {
            border: 4px solid var(--dark-border);
            border-top: 4px solid var(--neon-cyan);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid var(--error);
            color: var(--error);
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
            text-align: center;
            font-family: 'IBM Plex Mono', monospace;
        }

        .no-data {
            text-align: center;
            padding: 40px;
            color: var(--dark-text-secondary);
            font-size: 1.1em;
        }

        .slider-container {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .slider-value {
            min-width: 50px;
            text-align: center;
            font-family: 'IBM Plex Mono', monospace;
            font-weight: 600;
            color: var(--neon-cyan);
        }

        input[type="range"] {
            flex: 1;
            max-width: 300px;
        }

        /* Custom range slider styling */
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--neon-cyan);
            cursor: pointer;
            box-shadow: 0 0 8px rgba(6, 182, 212, 0.5);
            transition: all 0.2s ease;
        }

        input[type="range"]::-webkit-slider-thumb:hover {
            box-shadow: 0 0 12px rgba(6, 182, 212, 0.8);
            transform: scale(1.1);
        }

        input[type="range"]::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--neon-cyan);
            cursor: pointer;
            box-shadow: 0 0 8px rgba(6, 182, 212, 0.5);
            border: none;
        }

        .timestamp {
            text-align: center;
            color: var(--dark-text-tertiary);
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.75em;
            margin-top: 20px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        /* Footer Branding */
        .footer-branding {
            text-align: center;
            padding: 20px;
            margin-top: 40px;
            border-top: 1px solid var(--dark-border);
            font-family: 'Inter', sans-serif;
            font-size: 0.75rem;
            color: var(--dark-text-secondary);
        }

        .footer-branding span {
            color: var(--neon-amber);
        }
    </style>
</head>
<body>
    <div class="header">
        <h1><span>Virtuoso</span> Predictive Analytics</h1>
        <div class="subtitle">Real-time 5-Signal Trading Intelligence</div>
    </div>

    <div class="controls">
        <div class="control-group">
            <label for="timeframe">Timeframe</label>
            <select id="timeframe">
                <option value="1">1 Hour</option>
                <option value="4" selected>4 Hours</option>
            </select>
        </div>

        <div class="control-group">
            <label for="minStability">Min Stability Score</label>
            <div class="slider-container">
                <input type="range" id="minStability" min="0" max="100" value="50" step="10">
                <span class="slider-value" id="stabilityValue">50</span>
            </div>
        </div>

        <div class="control-group">
            <label for="minZScore">Min Z-Score (Actionable)</label>
            <div class="slider-container">
                <input type="range" id="minZScore" min="1.5" max="4.0" value="2.5" step="0.5">
                <span class="slider-value" id="zScoreValue">2.5</span>
            </div>
        </div>

        <div class="control-group">
            <label>&nbsp;</label>
            <button onclick="loadData()">ðŸ”„ Refresh Data</button>
        </div>
    </div>

    <div id="loadingIndicator" class="loading" style="display: none;">
        <div class="spinner"></div>
        <div>Loading predictive signals...</div>
    </div>

    <div id="errorContainer"></div>

    <div id="mainContent" style="display: none;">
        <!-- Overview Section -->
        <div class="overview-grid" id="overviewGrid"></div>

        <!-- Actionable Trades Section -->
        <div class="section" id="actionableSection" style="display: none;">
            <h2 class="section-title">ðŸŽ¯ High-Confidence Actionable Trades</h2>
            <div class="actionable-grid" id="actionableGrid"></div>
        </div>

        <!-- Altcoin Rankings Table -->
        <div class="section">
            <h2 class="section-title">ðŸ“Š Altcoin Rankings</h2>
            <div class="table-container">
                <table id="rankingsTable">
                    <thead>
                        <tr>
                            <th class="sortable" data-column="symbol">Symbol</th>
                            <th class="sortable" data-column="stability_score">Stability Score</th>
                            <th class="sortable" data-column="beta">Beta</th>
                            <th class="sortable" data-column="correlation">Correlation</th>
                            <th class="sortable" data-column="lag">Lag (min)</th>
                            <th class="sortable" data-column="z_score">Z-Score</th>
                            <th>Signal</th>
                        </tr>
                    </thead>
                    <tbody id="rankingsBody"></tbody>
                </table>
            </div>
        </div>

        <!-- Visualizations Grid -->
        <div class="section">
            <h2 class="section-title">ðŸ“ˆ Signal Visualizations</h2>

            <!-- Beta vs Stability Scatter -->
            <div class="chart-container">
                <div id="betaStabilityScatter"></div>
            </div>

            <!-- Two-column charts -->
            <div class="chart-grid">
                <!-- Lead-Lag Timing -->
                <div class="chart-container">
                    <div id="leadLagChart"></div>
                </div>

                <!-- Divergence Signals -->
                <div class="chart-container">
                    <div id="divergenceChart"></div>
                </div>
            </div>

            <div class="chart-grid">
                <!-- Volatility Comparison -->
                <div class="chart-container">
                    <div id="volatilityChart"></div>
                </div>

                <!-- Stability Distribution -->
                <div class="chart-container">
                    <div id="stabilityDistribution"></div>
                </div>
            </div>
        </div>

        <div class="timestamp" id="timestamp"></div>

        <!-- Footer Branding -->
        <div class="footer-branding">
            Powered by <span>Virtuoso</span>
        </div>
    </div>

    <script>
        // Configuration
        const API_BASE = '/api/api';

        // Global state
        let currentData = null;
        let actionableData = null;
        let sortColumn = 'stability_score';
        let sortDirection = 'desc';

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
            loadData();
        });

        function setupEventListeners() {
            // Slider value updates
            document.getElementById('minStability').addEventListener('input', function(e) {
                document.getElementById('stabilityValue').textContent = e.target.value;
            });

            document.getElementById('minZScore').addEventListener('input', function(e) {
                document.getElementById('zScoreValue').textContent = e.target.value;
            });

            // Table sorting
            document.querySelectorAll('th.sortable').forEach(th => {
                th.addEventListener('click', function() {
                    const column = this.dataset.column;
                    if (sortColumn === column) {
                        sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
                    } else {
                        sortColumn = column;
                        sortDirection = 'desc';
                    }
                    renderTable();
                    updateTableHeaders();
                });
            });
        }

        async function loadData() {
            const timeframe = document.getElementById('timeframe').value;
            const minStability = document.getElementById('minStability').value;
            const minZScore = document.getElementById('minZScore').value;

            // Show loading
            document.getElementById('loadingIndicator').style.display = 'block';
            document.getElementById('mainContent').style.display = 'none';
            document.getElementById('errorContainer').innerHTML = '';

            try {
                // Fetch both endpoints
                const [predictiveResponse, actionableResponse] = await Promise.all([
                    fetch(`${API_BASE}/bitcoin-beta/predictive-signals?timeframe=${timeframe}&min_stability=${minStability}`),
                    fetch(`${API_BASE}/bitcoin-beta/actionable-trades?timeframe=${timeframe}&min_stability=70&min_z_score=${minZScore}`)
                ]);

                if (!predictiveResponse.ok || !actionableResponse.ok) {
                    throw new Error('API request failed');
                }

                currentData = await predictiveResponse.json();
                actionableData = await actionableResponse.json();

                // Check for data
                if (currentData.status !== 'success' || currentData.results.length === 0) {
                    showNoDataMessage();
                    return;
                }

                // Render all components
                renderOverview();
                renderActionableTrades();
                renderTable();
                renderCharts();
                updateTimestamp();

                // Show content
                document.getElementById('loadingIndicator').style.display = 'none';
                document.getElementById('mainContent').style.display = 'block';

            } catch (error) {
                console.error('Error loading data:', error);
                showError('Failed to load data from API. Please check connection and try again.');
                document.getElementById('loadingIndicator').style.display = 'none';
            }
        }

        function renderOverview() {
            const { btc_price, timeframe_hours, data_points, analysis_count, volatility_overview } = currentData;

            let volatilityClass = 'volatility-normal';
            let volatilityText = 'Normal';

            if (volatility_overview) {
                if (volatility_overview.spike_detected) {
                    volatilityClass = 'volatility-spike';
                    volatilityText = 'Spike Detected';
                } else if (volatility_overview.btc_vol_ratio > 1.5) {
                    volatilityClass = 'volatility-elevated';
                    volatilityText = 'Elevated';
                }
            }

            document.getElementById('overviewGrid').innerHTML = `
                <div class="stat-card">
                    <div class="label">Bitcoin Price</div>
                    <div class="value">$${btc_price ? btc_price.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2}) : 'N/A'}</div>
                </div>
                <div class="stat-card">
                    <div class="label">Timeframe</div>
                    <div class="value">${timeframe_hours}H</div>
                    <div class="subvalue">${data_points} data points</div>
                </div>
                <div class="stat-card">
                    <div class="label">Altcoins Analyzed</div>
                    <div class="value">${analysis_count}</div>
                    <div class="subvalue">${actionableData.signals_count} actionable signals</div>
                </div>
                <div class="stat-card">
                    <div class="label">Volatility Regime</div>
                    <div class="value">${volatility_overview ? volatility_overview.btc_vol_annualized_pct.toFixed(1) : 'N/A'}%</div>
                    <div class="volatility-badge ${volatilityClass}">${volatilityText}</div>
                </div>
            `;
        }

        function renderActionableTrades() {
            if (actionableData.signals_count === 0) {
                document.getElementById('actionableSection').style.display = 'none';
                return;
            }

            document.getElementById('actionableSection').style.display = 'block';

            const html = actionableData.signals.map(signal => {
                const directionClass = signal.divergence.direction;
                const directionText = signal.divergence.direction.toUpperCase();
                const confidence = signal.divergence.confidence;

                return `
                    <div class="trade-card ${directionClass}">
                        <div class="symbol">${signal.symbol}</div>
                        <div class="direction ${directionClass}">${directionText}</div>
                        <div class="metrics">
                            <div class="metric">
                                <div class="metric-label">Z-Score</div>
                                <div class="metric-value">${signal.divergence.z_score.toFixed(2)}</div>
                            </div>
                            <div class="metric">
                                <div class="metric-label">Confidence</div>
                                <div class="metric-value">${confidence}</div>
                            </div>
                            <div class="metric">
                                <div class="metric-label">Beta</div>
                                <div class="metric-value">${signal.beta.toFixed(2)}</div>
                            </div>
                            <div class="metric">
                                <div class="metric-label">Stability</div>
                                <div class="metric-value">${signal.stability.stability_score.toFixed(0)}</div>
                            </div>
                        </div>
                        <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.1); font-size: 0.9em; color: #a0aec0;">
                            Lag: ${signal.lead_lag.optimal_lag_minutes}min | Corr: ${signal.lead_lag.correlation.toFixed(2)}
                        </div>
                    </div>
                `;
            }).join('');

            document.getElementById('actionableGrid').innerHTML = html;
        }

        function renderTable() {
            if (!currentData || !currentData.results) return;

            // Sort data
            const sorted = [...currentData.results].sort((a, b) => {
                let aVal, bVal;

                switch(sortColumn) {
                    case 'symbol':
                        aVal = a.symbol;
                        bVal = b.symbol;
                        break;
                    case 'stability_score':
                        aVal = a.stability.stability_score;
                        bVal = b.stability.stability_score;
                        break;
                    case 'beta':
                        aVal = a.beta;
                        bVal = b.beta;
                        break;
                    case 'correlation':
                        aVal = a.lead_lag.correlation;
                        bVal = b.lead_lag.correlation;
                        break;
                    case 'lag':
                        aVal = a.lead_lag.optimal_lag_minutes;
                        bVal = b.lead_lag.optimal_lag_minutes;
                        break;
                    case 'z_score':
                        aVal = Math.abs(a.divergence.z_score);
                        bVal = Math.abs(b.divergence.z_score);
                        break;
                    default:
                        aVal = a.stability.stability_score;
                        bVal = b.stability.stability_score;
                }

                if (sortDirection === 'asc') {
                    return aVal > bVal ? 1 : -1;
                } else {
                    return aVal < bVal ? 1 : -1;
                }
            });

            const html = sorted.map(item => {
                const stability = item.stability.stability_score;
                let stabilityClass = 'stability-unstable';
                if (stability >= 80) stabilityClass = 'stability-very-stable';
                else if (stability >= 60) stabilityClass = 'stability-stable';
                else if (stability >= 40) stabilityClass = 'stability-moderate';

                let signalClass = 'signal-none';
                let signalText = '-';
                if (item.divergence.signal_active) {
                    signalClass = item.divergence.direction === 'long' ? 'signal-long' : 'signal-short';
                    signalText = item.divergence.direction.toUpperCase();
                }

                return `
                    <tr>
                        <td><strong>${item.symbol}</strong></td>
                        <td>
                            <span class="stability-badge ${stabilityClass}">
                                ${stability.toFixed(0)} - ${item.stability.rating}
                            </span>
                        </td>
                        <td>${item.beta.toFixed(2)}</td>
                        <td>${item.lead_lag.correlation.toFixed(2)}</td>
                        <td>${item.lead_lag.optimal_lag_minutes}</td>
                        <td>${item.divergence.z_score.toFixed(2)}</td>
                        <td><span class="signal-badge ${signalClass}">${signalText}</span></td>
                    </tr>
                `;
            }).join('');

            document.getElementById('rankingsBody').innerHTML = html;
            updateTableHeaders();
        }

        function updateTableHeaders() {
            document.querySelectorAll('th.sortable').forEach(th => {
                th.classList.remove('sorted-asc', 'sorted-desc');
                if (th.dataset.column === sortColumn) {
                    th.classList.add(sortDirection === 'asc' ? 'sorted-asc' : 'sorted-desc');
                }
            });
        }

        function renderCharts() {
            renderBetaStabilityScatter();
            renderLeadLagChart();
            renderDivergenceChart();
            renderVolatilityChart();
            renderStabilityDistribution();
        }

        function renderBetaStabilityScatter() {
            const data = currentData.results.map(item => ({
                symbol: item.symbol,
                beta: item.beta,
                stability: item.stability.stability_score,
                correlation: item.lead_lag.correlation,
                z_score: item.divergence.z_score,
                signal: item.divergence.signal_active ? item.divergence.direction : 'none'
            }));

            // Separate by signal type
            const longSignals = data.filter(d => d.signal === 'long');
            const shortSignals = data.filter(d => d.signal === 'short');
            const noSignal = data.filter(d => d.signal === 'none');

            const traces = [
                {
                    x: noSignal.map(d => d.beta),
                    y: noSignal.map(d => d.stability),
                    mode: 'markers',
                    type: 'scatter',
                    name: 'No Signal',
                    text: noSignal.map(d => d.symbol),
                    marker: {
                        size: noSignal.map(d => d.correlation * 30 + 5),
                        color: 'rgba(107, 114, 128, 0.6)',
                        line: { color: '#6b7280', width: 1 }
                    },
                    hovertemplate: '<b>%{text}</b><br>Beta: %{x:.2f}<br>Stability: %{y:.0f}<extra></extra>'
                },
                {
                    x: longSignals.map(d => d.beta),
                    y: longSignals.map(d => d.stability),
                    mode: 'markers',
                    type: 'scatter',
                    name: 'Long Signal',
                    text: longSignals.map(d => d.symbol),
                    marker: {
                        size: longSignals.map(d => d.correlation * 30 + 5),
                        color: 'rgba(16, 185, 129, 0.7)',
                        line: { color: '#10b981', width: 2 }
                    },
                    hovertemplate: '<b>%{text}</b><br>Beta: %{x:.2f}<br>Stability: %{y:.0f}<br>Z-Score: ' +
                                   longSignals.map(d => d.z_score.toFixed(2)).join(',') + '<extra></extra>'
                },
                {
                    x: shortSignals.map(d => d.beta),
                    y: shortSignals.map(d => d.stability),
                    mode: 'markers',
                    type: 'scatter',
                    name: 'Short Signal',
                    text: shortSignals.map(d => d.symbol),
                    marker: {
                        size: shortSignals.map(d => d.correlation * 30 + 5),
                        color: 'rgba(239, 68, 68, 0.7)',
                        line: { color: '#ef4444', width: 2 }
                    },
                    hovertemplate: '<b>%{text}</b><br>Beta: %{x:.2f}<br>Stability: %{y:.0f}<br>Z-Score: ' +
                                   shortSignals.map(d => d.z_score.toFixed(2)).join(',') + '<extra></extra>'
                }
            ];

            const layout = {
                title: {
                    text: 'Beta vs Stability (size = correlation strength)',
                    font: {
                        color: '#06B6D4',
                        size: 16,
                        family: 'IBM Plex Mono, monospace',
                        weight: 600
                    }
                },
                xaxis: {
                    title: {
                        text: 'Beta (BTC Sensitivity)',
                        font: { family: 'IBM Plex Mono, monospace' }
                    },
                    gridcolor: 'rgba(34, 34, 34, 0.8)',
                    color: '#9ca3af',
                    tickfont: { family: 'IBM Plex Mono, monospace' }
                },
                yaxis: {
                    title: {
                        text: 'Stability Score',
                        font: { family: 'IBM Plex Mono, monospace' }
                    },
                    gridcolor: 'rgba(34, 34, 34, 0.8)',
                    color: '#9ca3af',
                    tickfont: { family: 'IBM Plex Mono, monospace' }
                },
                plot_bgcolor: '#0a0a0a',
                paper_bgcolor: 'rgba(0,0,0,0)',
                font: {
                    color: '#e0e0e0',
                    family: 'Inter, sans-serif'
                },
                showlegend: true,
                legend: {
                    bgcolor: 'rgba(17, 17, 17, 0.8)',
                    bordercolor: '#222222',
                    borderwidth: 1,
                    font: { family: 'IBM Plex Mono, monospace' }
                },
                hovermode: 'closest'
            };

            const config = { responsive: true, displayModeBar: false };

            Plotly.newPlot('betaStabilityScatter', traces, layout, config);
        }

        function renderLeadLagChart() {
            const data = currentData.results
                .sort((a, b) => b.lead_lag.correlation - a.lead_lag.correlation)
                .slice(0, 15); // Top 15

            const trace = {
                x: data.map(d => d.lead_lag.optimal_lag_minutes),
                y: data.map(d => d.symbol),
                type: 'bar',
                orientation: 'h',
                marker: {
                    color: data.map(d => d.lead_lag.correlation),
                    colorscale: [[0, '#3b82f6'], [1, '#06B6D4']],
                    showscale: true,
                    colorbar: {
                        title: 'Correlation',
                        titlefont: {
                            color: '#06B6D4',
                            family: 'IBM Plex Mono, monospace'
                        },
                        tickfont: {
                            color: '#e0e0e0',
                            family: 'IBM Plex Mono, monospace'
                        }
                    }
                },
                text: data.map(d => `${d.lead_lag.optimal_lag_minutes}min (r=${d.lead_lag.correlation.toFixed(2)})`),
                textposition: 'auto',
                textfont: { family: 'IBM Plex Mono, monospace' },
                hovertemplate: '<b>%{y}</b><br>Lag: %{x} minutes<br>Correlation: %{marker.color:.2f}<extra></extra>'
            };

            const layout = {
                title: {
                    text: 'Lead-Lag Timing Analysis (Top 15 by Correlation)',
                    font: {
                        color: '#06B6D4',
                        size: 16,
                        family: 'IBM Plex Mono, monospace',
                        weight: 600
                    }
                },
                xaxis: {
                    title: {
                        text: 'Optimal Lag (Minutes)',
                        font: { family: 'IBM Plex Mono, monospace' }
                    },
                    gridcolor: 'rgba(34, 34, 34, 0.8)',
                    color: '#9ca3af',
                    tickfont: { family: 'IBM Plex Mono, monospace' }
                },
                yaxis: {
                    gridcolor: 'rgba(34, 34, 34, 0.8)',
                    color: '#9ca3af',
                    tickfont: { family: 'IBM Plex Mono, monospace' }
                },
                plot_bgcolor: '#0a0a0a',
                paper_bgcolor: 'rgba(0,0,0,0)',
                font: {
                    color: '#e0e0e0',
                    family: 'Inter, sans-serif'
                },
                margin: { l: 80 }
            };

            const config = { responsive: true, displayModeBar: false };

            Plotly.newPlot('leadLagChart', [trace], layout, config);
        }

        function renderDivergenceChart() {
            const data = currentData.results
                .filter(d => d.divergence.signal_active)
                .sort((a, b) => Math.abs(b.divergence.z_score) - Math.abs(a.divergence.z_score));

            if (data.length === 0) {
                document.getElementById('divergenceChart').innerHTML =
                    '<div class="no-data">No active divergence signals at current threshold</div>';
                return;
            }

            const trace = {
                x: data.map(d => d.divergence.z_score),
                y: data.map(d => d.symbol),
                type: 'bar',
                orientation: 'h',
                marker: {
                    color: data.map(d => d.divergence.direction === 'long' ? 'rgba(16, 185, 129, 0.7)' : 'rgba(239, 68, 68, 0.7)')
                },
                text: data.map(d => d.divergence.z_score.toFixed(2)),
                textposition: 'auto',
                textfont: { family: 'IBM Plex Mono, monospace' },
                hovertemplate: '<b>%{y}</b><br>Z-Score: %{x:.2f}<br>Direction: ' +
                               data.map(d => d.divergence.direction.toUpperCase()).join(',') + '<extra></extra>'
            };

            const layout = {
                title: {
                    text: 'Divergence Z-Scores (Mean-Reversion Signals)',
                    font: {
                        color: '#06B6D4',
                        size: 16,
                        family: 'IBM Plex Mono, monospace',
                        weight: 600
                    }
                },
                xaxis: {
                    title: {
                        text: 'Z-Score',
                        font: { family: 'IBM Plex Mono, monospace' }
                    },
                    gridcolor: 'rgba(34, 34, 34, 0.8)',
                    color: '#9ca3af',
                    tickfont: { family: 'IBM Plex Mono, monospace' },
                    zeroline: true,
                    zerolinecolor: '#222222',
                    zerolinewidth: 2
                },
                yaxis: {
                    gridcolor: 'rgba(34, 34, 34, 0.8)',
                    color: '#9ca3af',
                    tickfont: { family: 'IBM Plex Mono, monospace' }
                },
                shapes: [
                    {
                        type: 'line',
                        x0: 2.5,
                        x1: 2.5,
                        y0: -0.5,
                        y1: data.length - 0.5,
                        line: { color: '#f59e0b', width: 2, dash: 'dash' }
                    },
                    {
                        type: 'line',
                        x0: -2.5,
                        x1: -2.5,
                        y0: -0.5,
                        y1: data.length - 0.5,
                        line: { color: '#f59e0b', width: 2, dash: 'dash' }
                    }
                ],
                plot_bgcolor: '#0a0a0a',
                paper_bgcolor: 'rgba(0,0,0,0)',
                font: {
                    color: '#e0e0e0',
                    family: 'Inter, sans-serif'
                },
                margin: { l: 80 }
            };

            const config = { responsive: true, displayModeBar: false };

            Plotly.newPlot('divergenceChart', [trace], layout, config);
        }

        function renderVolatilityChart() {
            const data = currentData.results
                .filter(d => d.volatility)
                .sort((a, b) => b.volatility.expected_increase_pct - a.volatility.expected_increase_pct)
                .slice(0, 15);

            if (data.length === 0) {
                document.getElementById('volatilityChart').innerHTML =
                    '<div class="no-data">Volatility data not available</div>';
                return;
            }

            const trace1 = {
                x: data.map(d => d.symbol),
                y: data.map(d => d.volatility.alt_vol_current),
                type: 'bar',
                name: 'Current Vol',
                marker: { color: '#06B6D4' },
                hovertemplate: '<b>%{x}</b><br>Current: %{y:.2f}%<extra></extra>'
            };

            const trace2 = {
                x: data.map(d => d.symbol),
                y: data.map(d => d.volatility.alt_vol_predicted),
                type: 'bar',
                name: 'Predicted Vol',
                marker: { color: '#3b82f6' },
                hovertemplate: '<b>%{x}</b><br>Predicted: %{y:.2f}%<extra></extra>'
            };

            const layout = {
                title: {
                    text: 'Volatility: Current vs Predicted (Top 15 Expected Increase)',
                    font: {
                        color: '#06B6D4',
                        size: 16,
                        family: 'IBM Plex Mono, monospace',
                        weight: 600
                    }
                },
                xaxis: {
                    gridcolor: 'rgba(34, 34, 34, 0.8)',
                    color: '#9ca3af',
                    tickfont: { family: 'IBM Plex Mono, monospace' }
                },
                yaxis: {
                    title: {
                        text: 'Volatility (%)',
                        font: { family: 'IBM Plex Mono, monospace' }
                    },
                    gridcolor: 'rgba(34, 34, 34, 0.8)',
                    color: '#9ca3af',
                    tickfont: { family: 'IBM Plex Mono, monospace' }
                },
                barmode: 'group',
                plot_bgcolor: '#0a0a0a',
                paper_bgcolor: 'rgba(0,0,0,0)',
                font: {
                    color: '#e0e0e0',
                    family: 'Inter, sans-serif'
                },
                showlegend: true,
                legend: {
                    bgcolor: 'rgba(17, 17, 17, 0.8)',
                    bordercolor: '#222222',
                    borderwidth: 1,
                    font: { family: 'IBM Plex Mono, monospace' }
                }
            };

            const config = { responsive: true, displayModeBar: false };

            Plotly.newPlot('volatilityChart', [trace1, trace2], layout, config);
        }

        function renderStabilityDistribution() {
            const scores = currentData.results.map(d => d.stability.stability_score);

            const trace = {
                x: scores,
                type: 'histogram',
                nbinsx: 20,
                marker: {
                    color: scores.map(s => {
                        if (s >= 80) return 'rgba(6, 182, 212, 0.7)';
                        if (s >= 60) return 'rgba(16, 185, 129, 0.7)';
                        if (s >= 40) return 'rgba(245, 158, 11, 0.7)';
                        return 'rgba(239, 68, 68, 0.7)';
                    }),
                    line: { color: '#06B6D4', width: 1 }
                },
                hovertemplate: 'Stability: %{x:.0f}<br>Count: %{y}<extra></extra>'
            };

            const layout = {
                title: {
                    text: 'Stability Score Distribution',
                    font: {
                        color: '#06B6D4',
                        size: 16,
                        family: 'IBM Plex Mono, monospace',
                        weight: 600
                    }
                },
                xaxis: {
                    title: {
                        text: 'Stability Score',
                        font: { family: 'IBM Plex Mono, monospace' }
                    },
                    gridcolor: 'rgba(34, 34, 34, 0.8)',
                    color: '#9ca3af',
                    tickfont: { family: 'IBM Plex Mono, monospace' }
                },
                yaxis: {
                    title: {
                        text: 'Frequency',
                        font: { family: 'IBM Plex Mono, monospace' }
                    },
                    gridcolor: 'rgba(34, 34, 34, 0.8)',
                    color: '#9ca3af',
                    tickfont: { family: 'IBM Plex Mono, monospace' }
                },
                shapes: [
                    {
                        type: 'rect',
                        x0: 0,
                        x1: 40,
                        y0: 0,
                        y1: 1,
                        yref: 'paper',
                        fillcolor: 'rgba(239, 68, 68, 0.08)',
                        line: { width: 0 }
                    },
                    {
                        type: 'rect',
                        x0: 40,
                        x1: 60,
                        y0: 0,
                        y1: 1,
                        yref: 'paper',
                        fillcolor: 'rgba(245, 158, 11, 0.08)',
                        line: { width: 0 }
                    },
                    {
                        type: 'rect',
                        x0: 60,
                        x1: 80,
                        y0: 0,
                        y1: 1,
                        yref: 'paper',
                        fillcolor: 'rgba(16, 185, 129, 0.08)',
                        line: { width: 0 }
                    },
                    {
                        type: 'rect',
                        x0: 80,
                        x1: 100,
                        y0: 0,
                        y1: 1,
                        yref: 'paper',
                        fillcolor: 'rgba(16, 185, 129, 0.12)',
                        line: { width: 0 }
                    }
                ],
                plot_bgcolor: '#0a0a0a',
                paper_bgcolor: 'rgba(0,0,0,0)',
                font: {
                    color: '#e0e0e0',
                    family: 'Inter, sans-serif'
                }
            };

            const config = { responsive: true, displayModeBar: false };

            Plotly.newPlot('stabilityDistribution', [trace], layout, config);
        }

        function updateTimestamp() {
            const timestamp = currentData.timestamp || new Date().toISOString();
            const date = new Date(timestamp);
            document.getElementById('timestamp').textContent =
                `Last updated: ${date.toLocaleString()} UTC`;
        }

        function showError(message) {
            document.getElementById('errorContainer').innerHTML = `
                <div class="error-message">
                    <strong>âš ï¸ Error:</strong> ${message}
                </div>
            `;
        }

        function showNoDataMessage() {
            document.getElementById('loadingIndicator').style.display = 'none';
            document.getElementById('errorContainer').innerHTML = `
                <div class="no-data">
                    <h2>No Data Available</h2>
                    <p>No altcoin analysis data available for the selected parameters.</p>
                    <p>Try adjusting the timeframe or stability threshold.</p>
                </div>
            `;
        }
    </script>
</body>
</html>
